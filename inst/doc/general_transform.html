<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="John Mount, Nina Zumel" />

<meta name="date" content="2020-08-12" />

<title>General Data Transforms With cdata</title>

<script>// Hide empty <a> tag within highlighted CodeBlock for screen reader accessibility (see https://github.com/jgm/pandoc/issues/6352#issuecomment-626106786) -->
// v0.0.1
// Written by JooYoung Seo (jooyoung@psu.edu) and Atsushi Yasumoto on June 1st, 2020.

document.addEventListener('DOMContentLoaded', function() {
  const codeList = document.getElementsByClassName("sourceCode");
  for (var i = 0; i < codeList.length; i++) {
    var linkList = codeList[i].getElementsByTagName('a');
    for (var j = 0; j < linkList.length; j++) {
      if (linkList[j].innerHTML === "") {
        linkList[j].setAttribute('aria-hidden', 'true');
      }
    }
  }
});
</script>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>



<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">General Data Transforms With cdata</h1>
<h4 class="author">John Mount, Nina Zumel</h4>
<h4 class="date">2020-08-12</h4>



<p>One of the design goals of the <a href="https://github.com/WinVector/cdata"><code>cdata</code></a> <a href="https://www.r-project.org"><code>R</code></a> package is that data occurs in records, and records may be a pattern of cells in a groups of rows.</p>
<p>The allows <code>cdata</code> to support very powerful and arbitrary record transforms in one or two steps. Using “row records” (that is records that are exactly one row) as an intermediate lets us take just about any record shape to just about any record shape: first convert to row-records, then re-block the data into arbitrary record shapes (please see <a href="https://winvector.github.io/cdata/articles/blocksrecs.html">here</a> and <a href="https://winvector.github.io/cdata/articles/design.html">here</a> for the concepts).</p>
<p>But as with all general ideas, it is much easier to see what we mean by the above with a concrete example. Let’s consider the following artificial (but simple) example. Suppose we have the following data.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="kw">library</span>(<span class="st">&quot;cdata&quot;</span>)</span>
<span id="cb1-2"><a href="#cb1-2"></a></span>
<span id="cb1-3"><a href="#cb1-3"></a>data &lt;-<span class="st"> </span>wrapr<span class="op">::</span><span class="kw">build_frame</span>(</span>
<span id="cb1-4"><a href="#cb1-4"></a>   <span class="st">&quot;record_id&quot;</span>  , <span class="st">&quot;row&quot;</span> , <span class="st">&quot;col1&quot;</span>, <span class="st">&quot;col2&quot;</span>, <span class="st">&quot;col3&quot;</span> <span class="op">|</span></span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="st">     </span><span class="dv">1</span>          , <span class="st">&quot;row1&quot;</span>, <span class="dv">1</span>     , <span class="dv">2</span>     , <span class="dv">3</span>      <span class="op">|</span></span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="st">     </span><span class="dv">1</span>          , <span class="st">&quot;row2&quot;</span>, <span class="dv">4</span>     , <span class="dv">5</span>     , <span class="dv">6</span>      <span class="op">|</span></span>
<span id="cb1-7"><a href="#cb1-7"></a><span class="st">     </span><span class="dv">1</span>          , <span class="st">&quot;row3&quot;</span>, <span class="dv">7</span>     , <span class="dv">8</span>     , <span class="dv">9</span>      <span class="op">|</span></span>
<span id="cb1-8"><a href="#cb1-8"></a><span class="st">     </span><span class="dv">2</span>          , <span class="st">&quot;row1&quot;</span>, <span class="dv">11</span>    , <span class="dv">12</span>    , <span class="dv">13</span>     <span class="op">|</span></span>
<span id="cb1-9"><a href="#cb1-9"></a><span class="st">     </span><span class="dv">2</span>          , <span class="st">&quot;row2&quot;</span>, <span class="dv">14</span>    , <span class="dv">15</span>    , <span class="dv">16</span>     <span class="op">|</span></span>
<span id="cb1-10"><a href="#cb1-10"></a><span class="st">     </span><span class="dv">2</span>          , <span class="st">&quot;row3&quot;</span>, <span class="dv">17</span>    , <span class="dv">18</span>    , <span class="dv">19</span>     )</span>
<span id="cb1-11"><a href="#cb1-11"></a></span>
<span id="cb1-12"><a href="#cb1-12"></a>knitr<span class="op">::</span><span class="kw">kable</span>(data)</span></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="right">record_id</th>
<th align="left">row</th>
<th align="right">col1</th>
<th align="right">col2</th>
<th align="right">col3</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="left">row1</td>
<td align="right">1</td>
<td align="right">2</td>
<td align="right">3</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="left">row2</td>
<td align="right">4</td>
<td align="right">5</td>
<td align="right">6</td>
</tr>
<tr class="odd">
<td align="right">1</td>
<td align="left">row3</td>
<td align="right">7</td>
<td align="right">8</td>
<td align="right">9</td>
</tr>
<tr class="even">
<td align="right">2</td>
<td align="left">row1</td>
<td align="right">11</td>
<td align="right">12</td>
<td align="right">13</td>
</tr>
<tr class="odd">
<td align="right">2</td>
<td align="left">row2</td>
<td align="right">14</td>
<td align="right">15</td>
<td align="right">16</td>
</tr>
<tr class="even">
<td align="right">2</td>
<td align="left">row3</td>
<td align="right">17</td>
<td align="right">18</td>
<td align="right">19</td>
</tr>
</tbody>
</table>
<p>In the above the records are the triples of rows with matching <code>record_id</code> and the different rows within the record are identified by the value in the <code>row</code> column. So The data items are named by the triplet <code>record_id</code>, <code>row</code> and renaming column name (<code>col1</code>, <code>col2</code>, or <code>col2</code>). This sort of naming of values is essentially <a href="https://en.wikipedia.org/wiki/Codd%27s_12_rules">Codd’s “guaranteed access rule”</a>.</p>
<p>Suppose we want to transpose each of the records- swapping the row and column notions. With <code>cdata</code> this is easy. First you design a transform to flatten each complex record into a single wide row (using the design steps taught <a href="https://winvector.github.io/cdata/articles/design.html">here</a>). Essentially that is just specifying the following control variables. We define how to identify records (the key columns) and the structure of the records (giving the interior of the record arbitrary names we will re-use later).</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a>recordKeys =<span class="st"> &#39;record_id&#39;</span></span>
<span id="cb2-2"><a href="#cb2-2"></a></span>
<span id="cb2-3"><a href="#cb2-3"></a>incoming_shape &lt;-<span class="st"> </span>wrapr<span class="op">::</span><span class="kw">qchar_frame</span>(</span>
<span id="cb2-4"><a href="#cb2-4"></a>   <span class="st">&quot;row&quot;</span>   , <span class="st">&quot;col1&quot;</span>, <span class="st">&quot;col2&quot;</span>, <span class="st">&quot;col3&quot;</span> <span class="op">|</span></span>
<span id="cb2-5"><a href="#cb2-5"></a><span class="st">     &quot;row1&quot;</span>, v11   , v12   , v13    <span class="op">|</span></span>
<span id="cb2-6"><a href="#cb2-6"></a><span class="st">     &quot;row2&quot;</span>, v21   , v22   , v23    <span class="op">|</span></span>
<span id="cb2-7"><a href="#cb2-7"></a><span class="st">     &quot;row3&quot;</span>, v31   , v32   , v33    )</span></code></pre></div>
<p>And we specify (using the same principles) the desired final record shape, re-using the interior names from the first step to show where values are to be mapped.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a>outgoing_shape &lt;-<span class="st"> </span>wrapr<span class="op">::</span><span class="kw">qchar_frame</span>(</span>
<span id="cb3-2"><a href="#cb3-2"></a>   <span class="st">&quot;column_label&quot;</span>  , <span class="st">&quot;c_row1&quot;</span>, <span class="st">&quot;c_row2&quot;</span>, <span class="st">&quot;c_row3&quot;</span> <span class="op">|</span></span>
<span id="cb3-3"><a href="#cb3-3"></a><span class="st">     &quot;rec_col1&quot;</span>    , v11     , v21     , v31      <span class="op">|</span></span>
<span id="cb3-4"><a href="#cb3-4"></a><span class="st">     &quot;rec_col2&quot;</span>    , v12     , v22     , v32      <span class="op">|</span></span>
<span id="cb3-5"><a href="#cb3-5"></a><span class="st">     &quot;rec_col3&quot;</span>    , v13     , v23     , v33      )</span></code></pre></div>
<p>Once you have done this you specify the overall transform by building a layout specifying the incoming and outgoing record shapes.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a>layout &lt;-<span class="st"> </span><span class="kw">layout_specification</span>(</span>
<span id="cb4-2"><a href="#cb4-2"></a>  <span class="dt">incoming_shape =</span> incoming_shape,</span>
<span id="cb4-3"><a href="#cb4-3"></a>  <span class="dt">outgoing_shape =</span> outgoing_shape,</span>
<span id="cb4-4"><a href="#cb4-4"></a>  <span class="dt">recordKeys =</span> recordKeys)</span>
<span id="cb4-5"><a href="#cb4-5"></a></span>
<span id="cb4-6"><a href="#cb4-6"></a><span class="kw">print</span>(layout)</span>
<span id="cb4-7"><a href="#cb4-7"></a><span class="co">#&gt; {</span></span>
<span id="cb4-8"><a href="#cb4-8"></a><span class="co">#&gt;  in_record &lt;- wrapr::qchar_frame(</span></span>
<span id="cb4-9"><a href="#cb4-9"></a><span class="co">#&gt;    &quot;record_id&quot;  , &quot;row&quot; , &quot;col1&quot;, &quot;col2&quot;, &quot;col3&quot; |</span></span>
<span id="cb4-10"><a href="#cb4-10"></a><span class="co">#&gt;      .          , &quot;row1&quot;, v11   , v12   , v13    |</span></span>
<span id="cb4-11"><a href="#cb4-11"></a><span class="co">#&gt;      .          , &quot;row2&quot;, v21   , v22   , v23    |</span></span>
<span id="cb4-12"><a href="#cb4-12"></a><span class="co">#&gt;      .          , &quot;row3&quot;, v31   , v32   , v33    )</span></span>
<span id="cb4-13"><a href="#cb4-13"></a><span class="co">#&gt;  in_keys &lt;- c(&#39;record_id&#39;, &#39;row&#39;)</span></span>
<span id="cb4-14"><a href="#cb4-14"></a><span class="co">#&gt; </span></span>
<span id="cb4-15"><a href="#cb4-15"></a><span class="co">#&gt;  # becomes</span></span>
<span id="cb4-16"><a href="#cb4-16"></a><span class="co">#&gt; </span></span>
<span id="cb4-17"><a href="#cb4-17"></a><span class="co">#&gt;  out_record &lt;- wrapr::qchar_frame(</span></span>
<span id="cb4-18"><a href="#cb4-18"></a><span class="co">#&gt;    &quot;record_id&quot;  , &quot;column_label&quot;, &quot;c_row1&quot;, &quot;c_row2&quot;, &quot;c_row3&quot; |</span></span>
<span id="cb4-19"><a href="#cb4-19"></a><span class="co">#&gt;      .          , &quot;rec_col1&quot;    , v11     , v21     , v31      |</span></span>
<span id="cb4-20"><a href="#cb4-20"></a><span class="co">#&gt;      .          , &quot;rec_col2&quot;    , v12     , v22     , v32      |</span></span>
<span id="cb4-21"><a href="#cb4-21"></a><span class="co">#&gt;      .          , &quot;rec_col3&quot;    , v13     , v23     , v33      )</span></span>
<span id="cb4-22"><a href="#cb4-22"></a><span class="co">#&gt;  out_keys &lt;- c(&#39;record_id&#39;, &#39;column_label&#39;)</span></span>
<span id="cb4-23"><a href="#cb4-23"></a><span class="co">#&gt; </span></span>
<span id="cb4-24"><a href="#cb4-24"></a><span class="co">#&gt;  # args: c(checkNames = TRUE, checkKeys = TRUE, strict = FALSE, allow_rqdatatable = FALSE)</span></span>
<span id="cb4-25"><a href="#cb4-25"></a><span class="co">#&gt; }</span></span></code></pre></div>
<p>This layout specification or controller can then perform the transform.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a>data <span class="op">%.&gt;%</span></span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="st">  </span>layout <span class="op">%.&gt;%</span></span>
<span id="cb5-3"><a href="#cb5-3"></a><span class="st">  </span>knitr<span class="op">::</span><span class="kw">kable</span>(.)</span></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="right">record_id</th>
<th align="left">column_label</th>
<th align="right">c_row1</th>
<th align="right">c_row2</th>
<th align="right">c_row3</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="left">rec_col1</td>
<td align="right">1</td>
<td align="right">4</td>
<td align="right">7</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="left">rec_col2</td>
<td align="right">2</td>
<td align="right">5</td>
<td align="right">8</td>
</tr>
<tr class="odd">
<td align="right">1</td>
<td align="left">rec_col3</td>
<td align="right">3</td>
<td align="right">6</td>
<td align="right">9</td>
</tr>
<tr class="even">
<td align="right">2</td>
<td align="left">rec_col1</td>
<td align="right">11</td>
<td align="right">14</td>
<td align="right">17</td>
</tr>
<tr class="odd">
<td align="right">2</td>
<td align="left">rec_col2</td>
<td align="right">12</td>
<td align="right">15</td>
<td align="right">18</td>
</tr>
<tr class="even">
<td align="right">2</td>
<td align="left">rec_col3</td>
<td align="right">13</td>
<td align="right">16</td>
<td align="right">19</td>
</tr>
</tbody>
</table>
<p>And the transform is done, each record has been transposed.</p>
<p>The principle is “draw a picture.” First we draw a picture of the block record structure we have, and then we draw a picture of the block record structure we want.</p>
<p>As you have seen, we have complete freedom to re-name columns and record-piece labels (the labels that tell us which portion of a block-record each row fits into).</p>
<p>If you don’t want to use pipe notation, you can use the method <code>layout_by()</code> (which takes a layout specification as an argument) or the method <code>convert_records()</code> (which takes the components of the transform specification as separate arguments).</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a>lr &lt;-<span class="st"> </span><span class="kw">layout_by</span>(layout, data)</span>
<span id="cb6-2"><a href="#cb6-2"></a>knitr<span class="op">::</span><span class="kw">kable</span>(lr)</span></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="right">record_id</th>
<th align="left">column_label</th>
<th align="right">c_row1</th>
<th align="right">c_row2</th>
<th align="right">c_row3</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="left">rec_col1</td>
<td align="right">1</td>
<td align="right">4</td>
<td align="right">7</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="left">rec_col2</td>
<td align="right">2</td>
<td align="right">5</td>
<td align="right">8</td>
</tr>
<tr class="odd">
<td align="right">1</td>
<td align="left">rec_col3</td>
<td align="right">3</td>
<td align="right">6</td>
<td align="right">9</td>
</tr>
<tr class="even">
<td align="right">2</td>
<td align="left">rec_col1</td>
<td align="right">11</td>
<td align="right">14</td>
<td align="right">17</td>
</tr>
<tr class="odd">
<td align="right">2</td>
<td align="left">rec_col2</td>
<td align="right">12</td>
<td align="right">15</td>
<td align="right">18</td>
</tr>
<tr class="even">
<td align="right">2</td>
<td align="left">rec_col3</td>
<td align="right">13</td>
<td align="right">16</td>
<td align="right">19</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a></span>
<span id="cb7-2"><a href="#cb7-2"></a>cr &lt;-<span class="st"> </span><span class="kw">convert_records</span>(</span>
<span id="cb7-3"><a href="#cb7-3"></a>  data,</span>
<span id="cb7-4"><a href="#cb7-4"></a>  <span class="dt">keyColumns =</span> recordKeys,</span>
<span id="cb7-5"><a href="#cb7-5"></a>  <span class="dt">incoming_shape =</span> incoming_shape,</span>
<span id="cb7-6"><a href="#cb7-6"></a>  <span class="dt">outgoing_shape =</span> outgoing_shape)</span>
<span id="cb7-7"><a href="#cb7-7"></a></span>
<span id="cb7-8"><a href="#cb7-8"></a>knitr<span class="op">::</span><span class="kw">kable</span>(cr)</span></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="right">record_id</th>
<th align="left">column_label</th>
<th align="right">c_row1</th>
<th align="right">c_row2</th>
<th align="right">c_row3</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="left">rec_col1</td>
<td align="right">1</td>
<td align="right">4</td>
<td align="right">7</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="left">rec_col2</td>
<td align="right">2</td>
<td align="right">5</td>
<td align="right">8</td>
</tr>
<tr class="odd">
<td align="right">1</td>
<td align="left">rec_col3</td>
<td align="right">3</td>
<td align="right">6</td>
<td align="right">9</td>
</tr>
<tr class="even">
<td align="right">2</td>
<td align="left">rec_col1</td>
<td align="right">11</td>
<td align="right">14</td>
<td align="right">17</td>
</tr>
<tr class="odd">
<td align="right">2</td>
<td align="left">rec_col2</td>
<td align="right">12</td>
<td align="right">15</td>
<td align="right">18</td>
</tr>
<tr class="even">
<td align="right">2</td>
<td align="left">rec_col3</td>
<td align="right">13</td>
<td align="right">16</td>
<td align="right">19</td>
</tr>
</tbody>
</table>
<p>A nifty bonus is: if the transformation is “faithful” (preserves enough cells and labels), then it is invertible and in fact easy to invert (by the <code>t()</code> transpose/adjoint function).</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a>inv_layout &lt;-<span class="st"> </span><span class="kw">t</span>(layout)</span>
<span id="cb8-2"><a href="#cb8-2"></a></span>
<span id="cb8-3"><a href="#cb8-3"></a><span class="kw">print</span>(inv_layout)</span>
<span id="cb8-4"><a href="#cb8-4"></a><span class="co">#&gt; {</span></span>
<span id="cb8-5"><a href="#cb8-5"></a><span class="co">#&gt;  in_record &lt;- wrapr::qchar_frame(</span></span>
<span id="cb8-6"><a href="#cb8-6"></a><span class="co">#&gt;    &quot;record_id&quot;  , &quot;column_label&quot;, &quot;c_row1&quot;, &quot;c_row2&quot;, &quot;c_row3&quot; |</span></span>
<span id="cb8-7"><a href="#cb8-7"></a><span class="co">#&gt;      .          , &quot;rec_col1&quot;    , v11     , v21     , v31      |</span></span>
<span id="cb8-8"><a href="#cb8-8"></a><span class="co">#&gt;      .          , &quot;rec_col2&quot;    , v12     , v22     , v32      |</span></span>
<span id="cb8-9"><a href="#cb8-9"></a><span class="co">#&gt;      .          , &quot;rec_col3&quot;    , v13     , v23     , v33      )</span></span>
<span id="cb8-10"><a href="#cb8-10"></a><span class="co">#&gt;  in_keys &lt;- c(&#39;record_id&#39;, &#39;column_label&#39;)</span></span>
<span id="cb8-11"><a href="#cb8-11"></a><span class="co">#&gt; </span></span>
<span id="cb8-12"><a href="#cb8-12"></a><span class="co">#&gt;  # becomes</span></span>
<span id="cb8-13"><a href="#cb8-13"></a><span class="co">#&gt; </span></span>
<span id="cb8-14"><a href="#cb8-14"></a><span class="co">#&gt;  out_record &lt;- wrapr::qchar_frame(</span></span>
<span id="cb8-15"><a href="#cb8-15"></a><span class="co">#&gt;    &quot;record_id&quot;  , &quot;row&quot; , &quot;col1&quot;, &quot;col2&quot;, &quot;col3&quot; |</span></span>
<span id="cb8-16"><a href="#cb8-16"></a><span class="co">#&gt;      .          , &quot;row1&quot;, v11   , v12   , v13    |</span></span>
<span id="cb8-17"><a href="#cb8-17"></a><span class="co">#&gt;      .          , &quot;row2&quot;, v21   , v22   , v23    |</span></span>
<span id="cb8-18"><a href="#cb8-18"></a><span class="co">#&gt;      .          , &quot;row3&quot;, v31   , v32   , v33    )</span></span>
<span id="cb8-19"><a href="#cb8-19"></a><span class="co">#&gt;  out_keys &lt;- c(&#39;record_id&#39;, &#39;row&#39;)</span></span>
<span id="cb8-20"><a href="#cb8-20"></a><span class="co">#&gt; </span></span>
<span id="cb8-21"><a href="#cb8-21"></a><span class="co">#&gt;  # args: c(checkNames = TRUE, checkKeys = TRUE, strict = FALSE, allow_rqdatatable = FALSE)</span></span>
<span id="cb8-22"><a href="#cb8-22"></a><span class="co">#&gt; }</span></span>
<span id="cb8-23"><a href="#cb8-23"></a></span>
<span id="cb8-24"><a href="#cb8-24"></a>data <span class="op">%.&gt;%</span></span>
<span id="cb8-25"><a href="#cb8-25"></a><span class="st">  </span>layout <span class="op">%.&gt;%</span></span>
<span id="cb8-26"><a href="#cb8-26"></a><span class="st">  </span>inv_layout <span class="op">%.&gt;%</span></span>
<span id="cb8-27"><a href="#cb8-27"></a><span class="st">  </span>knitr<span class="op">::</span><span class="kw">kable</span>(.)</span></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="right">record_id</th>
<th align="left">row</th>
<th align="right">col1</th>
<th align="right">col2</th>
<th align="right">col3</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="left">row1</td>
<td align="right">1</td>
<td align="right">2</td>
<td align="right">3</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="left">row2</td>
<td align="right">4</td>
<td align="right">5</td>
<td align="right">6</td>
</tr>
<tr class="odd">
<td align="right">1</td>
<td align="left">row3</td>
<td align="right">7</td>
<td align="right">8</td>
<td align="right">9</td>
</tr>
<tr class="even">
<td align="right">2</td>
<td align="left">row1</td>
<td align="right">11</td>
<td align="right">12</td>
<td align="right">13</td>
</tr>
<tr class="odd">
<td align="right">2</td>
<td align="left">row2</td>
<td align="right">14</td>
<td align="right">15</td>
<td align="right">16</td>
</tr>
<tr class="even">
<td align="right">2</td>
<td align="left">row3</td>
<td align="right">17</td>
<td align="right">18</td>
<td align="right">19</td>
</tr>
</tbody>
</table>
<p>Also these conversions can also be translated into <a href="https://github.com/WinVector/rquery"><code>rquery</code></a> operators, and therefore saved to be run either in memory or directly on a database.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a>table_desciption &lt;-<span class="st"> </span>rquery<span class="op">::</span><span class="kw">local_td</span>(data)</span>
<span id="cb9-2"><a href="#cb9-2"></a>ops &lt;-<span class="st"> </span>table_desciption <span class="op">%.&gt;%</span></span>
<span id="cb9-3"><a href="#cb9-3"></a><span class="st">  </span>layout</span>
<span id="cb9-4"><a href="#cb9-4"></a></span>
<span id="cb9-5"><a href="#cb9-5"></a><span class="kw">cat</span>(<span class="kw">format</span>(ops))</span>
<span id="cb9-6"><a href="#cb9-6"></a><span class="co">#&gt; mk_td(&quot;data&quot;, c(</span></span>
<span id="cb9-7"><a href="#cb9-7"></a><span class="co">#&gt;   &quot;record_id&quot;,</span></span>
<span id="cb9-8"><a href="#cb9-8"></a><span class="co">#&gt;   &quot;row&quot;,</span></span>
<span id="cb9-9"><a href="#cb9-9"></a><span class="co">#&gt;   &quot;col1&quot;,</span></span>
<span id="cb9-10"><a href="#cb9-10"></a><span class="co">#&gt;   &quot;col2&quot;,</span></span>
<span id="cb9-11"><a href="#cb9-11"></a><span class="co">#&gt;   &quot;col3&quot;)) %.&gt;%</span></span>
<span id="cb9-12"><a href="#cb9-12"></a><span class="co">#&gt;  non_sql_node(., CREATE TEMPORARY TABLE &quot;OUT&quot; AS  SELECT a.&quot;record_id&quot; &quot;record_id&quot;, MAX( CASE WHEN CAST(a.&quot;row&quot; AS VARCHAR) = &#39;row1&#39; THEN a.&quot;col1&quot; ELSE NULL </span><span class="re">END</span><span class="co"> ) &quot;v11&quot;, MAX( CASE WHEN CAST(a.&quot;row&quot; AS VARCHAR) = &#39;row1&#39; THEN a.&quot;col2&quot; ELSE NULL </span><span class="re">END</span><span class="co"> ) &quot;v12&quot;, MAX( CASE WHEN CAST(a.&quot;row&quot; AS VARCHAR) = &#39;row1&#39; THEN a.&quot;col3&quot; ELSE NULL </span><span class="re">END</span><span class="co"> ) &quot;v13&quot;, MAX( CASE WHEN CAST(a.&quot;row&quot; AS VARCHAR) = &#39;row2&#39; THEN a.&quot;col1&quot; ELSE NULL </span><span class="re">END</span><span class="co"> ) &quot;v21&quot;, MAX( CASE WHEN CAST(a.&quot;row&quot; AS VARCHAR) = &#39;row2&#39; THEN a.&quot;col2&quot; ELSE NULL </span><span class="re">END</span><span class="co"> ) &quot;v22&quot;, MAX( CASE WHEN CAST(a.&quot;row&quot; AS VARCHAR) = &#39;row2&#39; THEN a.&quot;col3&quot; ELSE NULL </span><span class="re">END</span><span class="co"> ) &quot;v23&quot;, MAX( CASE WHEN CAST(a.&quot;row&quot; AS VARCHAR) = &#39;row3&#39; THEN a.&quot;col1&quot; ELSE NULL </span><span class="re">END</span><span class="co"> ) &quot;v31&quot;, MAX( CASE WHEN CAST(a.&quot;row&quot; AS VARCHAR) = &#39;row3&#39; THEN a.&quot;col2&quot; ELSE NULL </span><span class="re">END</span><span class="co"> ) &quot;v32&quot;, MAX( CASE WHEN CAST(a.&quot;row&quot; AS VARCHAR) = &#39;row3&#39; THEN a.&quot;col3&quot; ELSE NULL </span><span class="re">END</span><span class="co"> ) &quot;v33&quot; FROM &quot;IN&quot; a GROUP BY a.&quot;record_id&quot;) %.&gt;%</span></span>
<span id="cb9-13"><a href="#cb9-13"></a><span class="co">#&gt;  non_sql_node(., CREATE TEMPORARY TABLE &quot;OUT&quot; AS  SELECT a.&quot;record_id&quot;, b.&quot;column_label&quot;, CASE  WHEN CAST(b.&quot;column_label&quot; AS VARCHAR) = &#39;rec_col1&#39; THEN a.&quot;v11&quot;  WHEN CAST(b.&quot;column_label&quot; AS VARCHAR) = &#39;rec_col2&#39; THEN a.&quot;v12&quot;  WHEN CAST(b.&quot;column_label&quot; AS VARCHAR) = &#39;rec_col3&#39; THEN a.&quot;v13&quot; ELSE NULL </span><span class="re">END</span><span class="co"> AS &quot;c_row1&quot;, CASE  WHEN CAST(b.&quot;column_label&quot; AS VARCHAR) = &#39;rec_col1&#39; THEN a.&quot;v21&quot;  WHEN CAST(b.&quot;column_label&quot; AS VARCHAR) = &#39;rec_col2&#39; THEN a.&quot;v22&quot;  WHEN CAST(b.&quot;column_label&quot; AS VARCHAR) = &#39;rec_col3&#39; THEN a.&quot;v23&quot; ELSE NULL </span><span class="re">END</span><span class="co"> AS &quot;c_row2&quot;, CASE  WHEN CAST(b.&quot;column_label&quot; AS VARCHAR) = &#39;rec_col1&#39; THEN a.&quot;v31&quot;  WHEN CAST(b.&quot;column_label&quot; AS VARCHAR) = &#39;rec_col2&#39; THEN a.&quot;v32&quot;  WHEN CAST(b.&quot;column_label&quot; AS VARCHAR) = &#39;rec_col3&#39; THEN a.&quot;v33&quot; ELSE NULL </span><span class="re">END</span><span class="co"> AS &quot;c_row3&quot; FROM &quot;IN&quot; a CROSS JOIN &quot;rrtbl_44612512869430682487_0000000002&quot; b )</span></span>
<span id="cb9-14"><a href="#cb9-14"></a></span>
<span id="cb9-15"><a href="#cb9-15"></a>rquery<span class="op">::</span><span class="kw">column_names</span>(ops) </span>
<span id="cb9-16"><a href="#cb9-16"></a><span class="co">#&gt; [1] &quot;record_id&quot;    &quot;column_label&quot; &quot;c_row1&quot;       &quot;c_row2&quot;       &quot;c_row3&quot;</span></span>
<span id="cb9-17"><a href="#cb9-17"></a></span>
<span id="cb9-18"><a href="#cb9-18"></a><span class="cf">if</span>(<span class="kw">requireNamespace</span>(<span class="st">&quot;DBI&quot;</span>, <span class="dt">quietly =</span> <span class="ot">TRUE</span>) <span class="op">&amp;&amp;</span></span>
<span id="cb9-19"><a href="#cb9-19"></a><span class="st">   </span><span class="kw">requireNamespace</span>(<span class="st">&quot;RSQLite&quot;</span>, <span class="dt">quietly =</span> <span class="ot">TRUE</span>)) {</span>
<span id="cb9-20"><a href="#cb9-20"></a>  raw_connection &lt;-<span class="st"> </span>DBI<span class="op">::</span><span class="kw">dbConnect</span>(RSQLite<span class="op">::</span><span class="kw">SQLite</span>(), </span>
<span id="cb9-21"><a href="#cb9-21"></a>                                   <span class="st">&quot;:memory:&quot;</span>)</span>
<span id="cb9-22"><a href="#cb9-22"></a>  RSQLite<span class="op">::</span><span class="kw">initExtension</span>(raw_connection)</span>
<span id="cb9-23"><a href="#cb9-23"></a>  db &lt;-<span class="st"> </span>rquery<span class="op">::</span><span class="kw">rquery_db_info</span>(</span>
<span id="cb9-24"><a href="#cb9-24"></a>    <span class="dt">connection =</span> raw_connection,</span>
<span id="cb9-25"><a href="#cb9-25"></a>    <span class="dt">is_dbi =</span> <span class="ot">TRUE</span>,</span>
<span id="cb9-26"><a href="#cb9-26"></a>    <span class="dt">connection_options =</span> rquery<span class="op">::</span><span class="kw">rq_connection_tests</span>(raw_connection))</span>
<span id="cb9-27"><a href="#cb9-27"></a>  </span>
<span id="cb9-28"><a href="#cb9-28"></a>  db_td &lt;-<span class="st"> </span>rquery<span class="op">::</span><span class="kw">rq_copy_to</span>(db, <span class="st">&quot;data&quot;</span>, data)</span>
<span id="cb9-29"><a href="#cb9-29"></a>  </span>
<span id="cb9-30"><a href="#cb9-30"></a>  ops <span class="op">%.&gt;%</span><span class="st"> </span></span>
<span id="cb9-31"><a href="#cb9-31"></a><span class="st">    </span>db <span class="op">%.&gt;%</span><span class="st"> </span></span>
<span id="cb9-32"><a href="#cb9-32"></a><span class="st">    </span>knitr<span class="op">::</span><span class="kw">kable</span>(.) <span class="op">%.&gt;%</span></span>
<span id="cb9-33"><a href="#cb9-33"></a><span class="st">    </span><span class="kw">print</span>(.)</span>
<span id="cb9-34"><a href="#cb9-34"></a>  </span>
<span id="cb9-35"><a href="#cb9-35"></a>  DBI<span class="op">::</span><span class="kw">dbDisconnect</span>(raw_connection)</span>
<span id="cb9-36"><a href="#cb9-36"></a>}</span>
<span id="cb9-37"><a href="#cb9-37"></a><span class="co">#&gt; </span></span>
<span id="cb9-38"><a href="#cb9-38"></a><span class="co">#&gt; </span></span>
<span id="cb9-39"><a href="#cb9-39"></a><span class="co">#&gt; | record_id|column_label | c_row1| c_row2| c_row3|</span></span>
<span id="cb9-40"><a href="#cb9-40"></a><span class="co">#&gt; |---------:|:------------|------:|------:|------:|</span></span>
<span id="cb9-41"><a href="#cb9-41"></a><span class="co">#&gt; |         1|rec_col1     |      1|      4|      7|</span></span>
<span id="cb9-42"><a href="#cb9-42"></a><span class="co">#&gt; |         1|rec_col2     |      2|      5|      8|</span></span>
<span id="cb9-43"><a href="#cb9-43"></a><span class="co">#&gt; |         1|rec_col3     |      3|      6|      9|</span></span>
<span id="cb9-44"><a href="#cb9-44"></a><span class="co">#&gt; |         2|rec_col1     |     11|     14|     17|</span></span>
<span id="cb9-45"><a href="#cb9-45"></a><span class="co">#&gt; |         2|rec_col2     |     12|     15|     18|</span></span>
<span id="cb9-46"><a href="#cb9-46"></a><span class="co">#&gt; |         2|rec_col3     |     13|     16|     19|</span></span></code></pre></div>
<p>And that is some of the generality of <code>cdata</code> transforms.</p>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>

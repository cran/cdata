<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="author" content="John Mount, Nina Zumel; Win-Vector LLC" />

<meta name="date" content="2019-04-27" />

<title>cdata Exercises</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' || rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>



<link href="data:text/css;charset=utf-8,body%20%7B%0Abackground%2Dcolor%3A%20%23fff%3B%0Amargin%3A%201em%20auto%3B%0Amax%2Dwidth%3A%20700px%3B%0Aoverflow%3A%20visible%3B%0Apadding%2Dleft%3A%202em%3B%0Apadding%2Dright%3A%202em%3B%0Afont%2Dfamily%3A%20%22Open%20Sans%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0Afont%2Dsize%3A%2014px%3B%0Aline%2Dheight%3A%201%2E35%3B%0A%7D%0A%23header%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0A%23TOC%20%7B%0Aclear%3A%20both%3B%0Amargin%3A%200%200%2010px%2010px%3B%0Apadding%3A%204px%3B%0Awidth%3A%20400px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Aborder%2Dradius%3A%205px%3B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Afont%2Dsize%3A%2013px%3B%0Aline%2Dheight%3A%201%2E3%3B%0A%7D%0A%23TOC%20%2Etoctitle%20%7B%0Afont%2Dweight%3A%20bold%3B%0Afont%2Dsize%3A%2015px%3B%0Amargin%2Dleft%3A%205px%3B%0A%7D%0A%23TOC%20ul%20%7B%0Apadding%2Dleft%3A%2040px%3B%0Amargin%2Dleft%3A%20%2D1%2E5em%3B%0Amargin%2Dtop%3A%205px%3B%0Amargin%2Dbottom%3A%205px%3B%0A%7D%0A%23TOC%20ul%20ul%20%7B%0Amargin%2Dleft%3A%20%2D2em%3B%0A%7D%0A%23TOC%20li%20%7B%0Aline%2Dheight%3A%2016px%3B%0A%7D%0Atable%20%7B%0Amargin%3A%201em%20auto%3B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dcolor%3A%20%23DDDDDD%3B%0Aborder%2Dstyle%3A%20outset%3B%0Aborder%2Dcollapse%3A%20collapse%3B%0A%7D%0Atable%20th%20%7B%0Aborder%2Dwidth%3A%202px%3B%0Apadding%3A%205px%3B%0Aborder%2Dstyle%3A%20inset%3B%0A%7D%0Atable%20td%20%7B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dstyle%3A%20inset%3B%0Aline%2Dheight%3A%2018px%3B%0Apadding%3A%205px%205px%3B%0A%7D%0Atable%2C%20table%20th%2C%20table%20td%20%7B%0Aborder%2Dleft%2Dstyle%3A%20none%3B%0Aborder%2Dright%2Dstyle%3A%20none%3B%0A%7D%0Atable%20thead%2C%20table%20tr%2Eeven%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Ap%20%7B%0Amargin%3A%200%2E5em%200%3B%0A%7D%0Ablockquote%20%7B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Apadding%3A%200%2E25em%200%2E75em%3B%0A%7D%0Ahr%20%7B%0Aborder%2Dstyle%3A%20solid%3B%0Aborder%3A%20none%3B%0Aborder%2Dtop%3A%201px%20solid%20%23777%3B%0Amargin%3A%2028px%200%3B%0A%7D%0Adl%20%7B%0Amargin%2Dleft%3A%200%3B%0A%7D%0Adl%20dd%20%7B%0Amargin%2Dbottom%3A%2013px%3B%0Amargin%2Dleft%3A%2013px%3B%0A%7D%0Adl%20dt%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Aul%20%7B%0Amargin%2Dtop%3A%200%3B%0A%7D%0Aul%20li%20%7B%0Alist%2Dstyle%3A%20circle%20outside%3B%0A%7D%0Aul%20ul%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0Apre%2C%20code%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0Aborder%2Dradius%3A%203px%3B%0Acolor%3A%20%23333%3B%0Awhite%2Dspace%3A%20pre%2Dwrap%3B%20%0A%7D%0Apre%20%7B%0Aborder%2Dradius%3A%203px%3B%0Amargin%3A%205px%200px%2010px%200px%3B%0Apadding%3A%2010px%3B%0A%7D%0Apre%3Anot%28%5Bclass%5D%29%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Acode%20%7B%0Afont%2Dfamily%3A%20Consolas%2C%20Monaco%2C%20%27Courier%20New%27%2C%20monospace%3B%0Afont%2Dsize%3A%2085%25%3B%0A%7D%0Ap%20%3E%20code%2C%20li%20%3E%20code%20%7B%0Apadding%3A%202px%200px%3B%0A%7D%0Adiv%2Efigure%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0Aimg%20%7B%0Abackground%2Dcolor%3A%20%23FFFFFF%3B%0Apadding%3A%202px%3B%0Aborder%3A%201px%20solid%20%23DDDDDD%3B%0Aborder%2Dradius%3A%203px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Amargin%3A%200%205px%3B%0A%7D%0Ah1%20%7B%0Amargin%2Dtop%3A%200%3B%0Afont%2Dsize%3A%2035px%3B%0Aline%2Dheight%3A%2040px%3B%0A%7D%0Ah2%20%7B%0Aborder%2Dbottom%3A%204px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Apadding%2Dbottom%3A%202px%3B%0Afont%2Dsize%3A%20145%25%3B%0A%7D%0Ah3%20%7B%0Aborder%2Dbottom%3A%202px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Afont%2Dsize%3A%20120%25%3B%0A%7D%0Ah4%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23f7f7f7%3B%0Amargin%2Dleft%3A%208px%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Ah5%2C%20h6%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23ccc%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Aa%20%7B%0Acolor%3A%20%230033dd%3B%0Atext%2Ddecoration%3A%20none%3B%0A%7D%0Aa%3Ahover%20%7B%0Acolor%3A%20%236666ff%3B%20%7D%0Aa%3Avisited%20%7B%0Acolor%3A%20%23800080%3B%20%7D%0Aa%3Avisited%3Ahover%20%7B%0Acolor%3A%20%23BB00BB%3B%20%7D%0Aa%5Bhref%5E%3D%22http%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0Aa%5Bhref%5E%3D%22https%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0A%0Acode%20%3E%20span%2Ekw%20%7B%20color%3A%20%23555%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Edt%20%7B%20color%3A%20%23902000%3B%20%7D%20%0Acode%20%3E%20span%2Edv%20%7B%20color%3A%20%2340a070%3B%20%7D%20%0Acode%20%3E%20span%2Ebn%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Efl%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Ech%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Est%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Eco%20%7B%20color%3A%20%23888888%3B%20font%2Dstyle%3A%20italic%3B%20%7D%20%0Acode%20%3E%20span%2Eot%20%7B%20color%3A%20%23007020%3B%20%7D%20%0Acode%20%3E%20span%2Eal%20%7B%20color%3A%20%23ff0000%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Efu%20%7B%20color%3A%20%23900%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%20code%20%3E%20span%2Eer%20%7B%20color%3A%20%23a61717%3B%20background%2Dcolor%3A%20%23e3d2d2%3B%20%7D%20%0A" rel="stylesheet" type="text/css" />




</head>

<body>




<h1 class="title toc-ignore">cdata Exercises</h1>
<h4 class="author">John Mount, Nina Zumel; Win-Vector LLC</h4>
<h4 class="date">2019-04-27</h4>



<p>In <a href="https://winvector.github.io/cdata/articles/exercises.html">this note</a> we will use five real life examples to demonstrate data layout transforms using the <a href="https://CRAN.R-project.org/package=cdata"><code>cdata</code></a> <a href="https://www.r-project.org"><code>R</code></a> package. The examples for this note are all demo-examples from <a href="https://github.com/tidyverse/tidyr/tree/master/demo">tidyr/demo/</a>, and are mostly based on questions posted to StackOverflow. They represent a good cross-section of data layout problems, so they are a good set of examples or exercises to work through.</p>
<p>For each of these examples we will show how to re-layout data using <a href="https://github.com/WinVector/cdata"><code>cdata</code></a>.</p>
<div id="introduction" class="section level2">
<h2>Introduction</h2>
<p>Each of these five problems will be solved using the same steps:</p>
<ul>
<li>Examine example input data and desired result data.</li>
<li><p>Check if either the incoming or outgoing data format is in “row-record” format: is all the data for a single record contained in one row? This determines which data layout transform specification you will use:</p>
<ul>
<li><code>rowrecs_to_blocks_spec()</code>: To specify data moving from single rows to arbitrary “block-shaped” records</li>
<li><code>blocks_to_rowrecs_spec()</code>: To specify data moving from block records to single rows</li>
<li><code>layout_specification()</code>: To specify data moving one shape of general block record to another block record.</li>
</ul></li>
<li>Identify which columns form the record ids (group sets of rows into records), which we call the “record keys.”</li>
<li>Draw the shape of the incoming record without the record key columns.</li>
<li>Draw the shape of the outgoing record without the record key columns.</li>
<li>Combine the above information as one of the above data layout transform specifications.</li>
<li>Print the layout transform to confirm it is what you want.</li>
<li><p>Apply the layout transform.</p></li>
</ul>
<p>This may seem like a lot of steps, but it is only because we are taking the problems very slowly. The important point is that we want to minimize <em>additional</em> problem solving when applying the <code>cdata</code> methodology. Usually when you need to transform data you are in the middle of some other more important task, so you want to delegate the details of how the layout transform is implemented. With <code>cdata</code> the user is not asked to perform additional puzzle solving to guess a sequence of operators that may implement the desired data layout transform. The <code>cdata</code> solution pattern is always the same, which can help in mastering it.</p>
<p>With <code>cdata</code>, record layout transforms are simple <code>R</code> objects with detailed <code>print()</code> methods- so they are convenient to alter, save, and re-use later. The record layout transform also documents the expected columns and constants of the incoming data.</p>
<p>We will work some examples with the hope that practice brings familiarity. We have some notes on how to graphically solve exercise like this <a href="https://winvector.github.io/cdata/articles/design.html">here</a> and <a href="http://www.win-vector.com/blog/2019/04/controlling-data-layout-with-cdata/">here</a>, but let’s dive into working the exercises.</p>
</div>
<div id="example-1" class="section level2">
<h2>Example 1</h2>
<p>(From: <a href="https://github.com/tidyverse/tidyr/blob/master/demo/dadmom.R" class="uri">https://github.com/tidyverse/tidyr/blob/master/demo/dadmom.R</a>.)</p>
<p>From <a href="https://stats.idre.ucla.edu/stata/modules/reshaping-data-wide-to-long/" class="uri">https://stats.idre.ucla.edu/stata/modules/reshaping-data-wide-to-long/</a> we can get get a copy of the data and the question or “transform ask”:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># convert from this format</span>
dadmomw &lt;-<span class="st"> </span>wrapr<span class="op">::</span><span class="kw">build_frame</span>(
   <span class="st">&quot;famid&quot;</span>  , <span class="st">&quot;named&quot;</span>, <span class="st">&quot;incd&quot;</span>, <span class="st">&quot;namem&quot;</span>, <span class="st">&quot;incm&quot;</span> <span class="op">|</span>
<span class="st">     </span><span class="dv">1</span>      , <span class="st">&quot;Bill&quot;</span> , <span class="dv">30000</span> , <span class="st">&quot;Bess&quot;</span> , <span class="dv">15000</span>  <span class="op">|</span>
<span class="st">     </span><span class="dv">2</span>      , <span class="st">&quot;Art&quot;</span>  , <span class="dv">22000</span> , <span class="st">&quot;Amy&quot;</span>  , <span class="dv">18000</span>  <span class="op">|</span>
<span class="st">     </span><span class="dv">3</span>      , <span class="st">&quot;Paul&quot;</span> , <span class="dv">25000</span> , <span class="st">&quot;Pat&quot;</span>  , <span class="dv">50000</span>  )

<span class="co"># to this format</span>
dadmomt &lt;-<span class="st"> </span>wrapr<span class="op">::</span><span class="kw">build_frame</span>(
   <span class="st">&quot;famid&quot;</span>  , <span class="st">&quot;dadmom&quot;</span>, <span class="st">&quot;name&quot;</span>, <span class="st">&quot;inc&quot;</span> <span class="op">|</span>
<span class="st">     </span><span class="dv">1</span>      , <span class="st">&quot;d&quot;</span>     , <span class="st">&quot;Bill&quot;</span>, <span class="dv">30000</span> <span class="op">|</span>
<span class="st">     </span><span class="dv">1</span>      , <span class="st">&quot;m&quot;</span>     , <span class="st">&quot;Bess&quot;</span>, <span class="dv">15000</span> <span class="op">|</span>
<span class="st">     </span><span class="dv">2</span>      , <span class="st">&quot;d&quot;</span>     , <span class="st">&quot;Art&quot;</span> , <span class="dv">22000</span> <span class="op">|</span>
<span class="st">     </span><span class="dv">2</span>      , <span class="st">&quot;m&quot;</span>     , <span class="st">&quot;Amy&quot;</span> , <span class="dv">18000</span> <span class="op">|</span>
<span class="st">     </span><span class="dv">3</span>      , <span class="st">&quot;d&quot;</span>     , <span class="st">&quot;Paul&quot;</span>, <span class="dv">25000</span> <span class="op">|</span>
<span class="st">     </span><span class="dv">3</span>      , <span class="st">&quot;m&quot;</span>     , <span class="st">&quot;Pat&quot;</span> , <span class="dv">50000</span> )</code></pre></div>
<p>Each incoming record represents a family, and is designated by the record key <code>famid</code>. The data starts with each record in a single row (a row record):</p>
<table>
<thead>
<tr class="header">
<th align="right">famid</th>
<th align="left">named</th>
<th align="right">incd</th>
<th align="left">namem</th>
<th align="right">incm</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="left">Bill</td>
<td align="right">30000</td>
<td align="left">Bess</td>
<td align="right">15000</td>
</tr>
</tbody>
</table>
<p>So we are going from a row record to a general block record: this means we want to use <code>rowrecs_to_blocks_spec()</code>, and we only have to describe the outgoing record shape.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&quot;cdata&quot;</span>)

<span class="co"># identify the record key</span>
recordKeys &lt;-<span class="st"> &quot;famid&quot;</span>

<span class="co"># specify the outgoing record shape</span>
outgoing_record &lt;-<span class="st"> </span>wrapr<span class="op">::</span><span class="kw">qchar_frame</span>(
   <span class="st">&quot;dadmom&quot;</span>  , <span class="st">&quot;name&quot;</span>, <span class="st">&quot;inc&quot;</span> <span class="op">|</span>
<span class="st">     &quot;d&quot;</span>     , named , incd <span class="op">|</span>
<span class="st">     &quot;m&quot;</span>     , namem , incm )</code></pre></div>
<p>Notice we take the column names from the incoming row-record and use them as cell-names in the outgoing record; this is how we show where the data goes. In specifying the record with <code>wrapr::qchar_frame()</code>, we use the convention that quoted entities are values we know (values that specify column names, or keys that describe the interior of the block record structure), and un-quoted entities are values we expect to be in the record.</p>
<p><code>outgoing_record</code> is just a <code>data.frame</code>, you can create it however you like – you don’t need to use <code>qchar_frame()</code>.</p>
<p>Now create the layout specification, and print it.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># put it all together into a layout</span>
layout &lt;-<span class="st"> </span><span class="kw">rowrecs_to_blocks_spec</span>(
  outgoing_record,
  <span class="dt">recordKeys =</span> recordKeys)

<span class="co"># confirm we have the right layout</span>
<span class="kw">print</span>(layout)
<span class="co">#&gt; {</span>
<span class="co">#&gt;  row_record &lt;- wrapr::qchar_frame(</span>
<span class="co">#&gt;    &quot;famid&quot;  , &quot;named&quot;, &quot;namem&quot;, &quot;incd&quot;, &quot;incm&quot; |</span>
<span class="co">#&gt;      .      , named  , namem  , incd  , incm   )</span>
<span class="co">#&gt;  row_keys &lt;- c('famid')</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;  # becomes</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;  block_record &lt;- wrapr::qchar_frame(</span>
<span class="co">#&gt;    &quot;famid&quot;  , &quot;dadmom&quot;, &quot;name&quot;, &quot;inc&quot; |</span>
<span class="co">#&gt;      .      , &quot;d&quot;     , named , incd  |</span>
<span class="co">#&gt;      .      , &quot;m&quot;     , namem , incm  )</span>
<span class="co">#&gt;  block_keys &lt;- c('famid', 'dadmom')</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;  # args: c(checkNames = TRUE, checkKeys = FALSE, strict = FALSE, allow_rqdatatable = TRUE)</span>
<span class="co">#&gt; }</span></code></pre></div>
<p>The <code>print()</code> method fully documents what columns are expected and the intent of the data layout transform. It uses the same quoted/unquoted convention that we used in specifying <code>outgoing_record</code> above.</p>
<p>The <em>block_keys</em> of the outgoing record shape specify the unique identifier of each row of the transformed data: that is, each row of <code>dadmomt</code> will be uniquely identified by the values of the columns <code>famid</code> and <code>dadmom</code> (which family, which parent). One of the block keys is always the record key; by default, <code>rowrecs_to_blocks_spec()</code> takes the other one from the first column of the <code>outgoing_record</code> shape. You can specify the block key (or keys) explicitly with the <code>controlTableKeys</code> argument:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># this is equivalent to the above call</span>
<span class="kw">rowrecs_to_blocks_spec</span>(
  outgoing_record,
  <span class="dt">recordKeys =</span> recordKeys,
  <span class="dt">controlTableKeys =</span> <span class="st">'dadmom'</span>)</code></pre></div>
<p>Now apply the layout to get the new data shape:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># apply the layout</span>
dadmomw <span class="op">%.&gt;%</span><span class="st"> </span>
<span class="st">  </span>layout <span class="op">%.&gt;%</span>
<span class="st">  </span>knitr<span class="op">::</span><span class="kw">kable</span>(.)</code></pre></div>
<table>
<thead>
<tr class="header">
<th align="right">famid</th>
<th align="left">dadmom</th>
<th align="left">name</th>
<th align="right">inc</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="left">d</td>
<td align="left">Bill</td>
<td align="right">30000</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="left">m</td>
<td align="left">Bess</td>
<td align="right">15000</td>
</tr>
<tr class="odd">
<td align="right">2</td>
<td align="left">d</td>
<td align="left">Art</td>
<td align="right">22000</td>
</tr>
<tr class="even">
<td align="right">2</td>
<td align="left">m</td>
<td align="left">Amy</td>
<td align="right">18000</td>
</tr>
<tr class="odd">
<td align="right">3</td>
<td align="left">d</td>
<td align="left">Paul</td>
<td align="right">25000</td>
</tr>
<tr class="even">
<td align="right">3</td>
<td align="left">m</td>
<td align="left">Pat</td>
<td align="right">50000</td>
</tr>
</tbody>
</table>
</div>
<div id="example-2" class="section level2">
<h2>Example 2</h2>
<p>(From: <a href="http://stackoverflow.com/questions/15668870/" class="uri">http://stackoverflow.com/questions/15668870/</a>, <a href="http://stackoverflow.com/questions/15668870/">https://github.com/tidyverse/tidyr/blob/master/demo/so-15668870.R</a>.)</p>
<p>The original question was:</p>
<pre><code>I want to reshape a wide format dataset that has multiple tests which are measured at 3 time points:

   ID   Test Year   Fall Spring Winter
    1   1   2008    15      16      19
    1   1   2009    12      13      27
    1   2   2008    22      22      24
    1   2   2009    10      14      20
 ...

into a data set that separates the tests by column but converts the measurement time into long format, for each of the new columns like this:

    ID  Year    Time        Test1 Test2
    1   2008    Fall        15      22
    1   2008    Spring      16      22
    1   2008    Winter      19      24
    1   2009    Fall        12      10
    1   2009    Spring      13      14
    1   2009    Winter      27      20
 ...

I have unsuccessfully tried to use reshape and melt. Existing posts address transforming to single column outcome.</code></pre>
<p>First, notice that neither the incoming nor outgoing forms are single-row records; a single record corresponds to a single ID and Year, and has three measurements (Fall, Spring, Winter) of two tests (1 and 2). So an example single row record would look something like:</p>
<pre><code>  ID Year Fall1 Fall2 Spring1 Spring2 Winter1 Winter2
   1 2008    15    22      16      22      19      24
</code></pre>
<p>and the record key is formed from the ID and the Year (sometimes what the record keys are is not obvious, and is in fact domain knowledge).</p>
<p>Since neither the incoming nor outgoing shapes are row records, we use the general <code>layout_specification()</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&quot;cdata&quot;</span>)

<span class="co"># identify the record keys</span>
recordKeys &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;ID&quot;</span>, <span class="st">&quot;Year&quot;</span>)

<span class="co"># specify the incoming record shape</span>
incoming_record &lt;-<span class="st"> </span>wrapr<span class="op">::</span><span class="kw">qchar_frame</span>(
  <span class="st">&quot;Test&quot;</span>  , <span class="st">&quot;Fall&quot;</span>   , <span class="st">&quot;Spring&quot;</span>     , <span class="st">&quot;Winter&quot;</span> <span class="op">|</span>
<span class="st">    &quot;1&quot;</span>   , Fall1    , Spring1      , Winter1  <span class="op">|</span>
<span class="st">    &quot;2&quot;</span>   , Fall2    , Spring2      , Winter2  )

<span class="co"># specify the outgoing record shape</span>
outgoing_record &lt;-<span class="st"> </span>wrapr<span class="op">::</span><span class="kw">qchar_frame</span>(
  <span class="st">&quot;Time&quot;</span>     , <span class="st">&quot;Test1&quot;</span> ,  <span class="st">&quot;Test2&quot;</span>   <span class="op">|</span>
<span class="st">    &quot;Fall&quot;</span>   , Fall1   ,   Fall2    <span class="op">|</span>
<span class="st">    &quot;Spring&quot;</span> , Spring1 ,   Spring2  <span class="op">|</span>
<span class="st">    &quot;Winter&quot;</span> , Winter1 ,   Winter2  )

<span class="co"># put it all together into a layout</span>
layout &lt;-<span class="st"> </span><span class="kw">layout_specification</span>(
  <span class="dt">incoming_shape =</span> incoming_record,
  <span class="dt">outgoing_shape =</span> outgoing_record,
  <span class="dt">recordKeys =</span> recordKeys)

<span class="co"># confirm we have the right layout</span>
<span class="kw">print</span>(layout)
<span class="co">#&gt; {</span>
<span class="co">#&gt;  in_record &lt;- wrapr::qchar_frame(</span>
<span class="co">#&gt;    &quot;ID&quot;  , &quot;Year&quot;, &quot;Test&quot;, &quot;Fall&quot;, &quot;Spring&quot;, &quot;Winter&quot; |</span>
<span class="co">#&gt;      .   , .     , &quot;1&quot;   , Fall1 , Spring1 , Winter1  |</span>
<span class="co">#&gt;      .   , .     , &quot;2&quot;   , Fall2 , Spring2 , Winter2  )</span>
<span class="co">#&gt;  in_keys &lt;- c('ID', 'Year', 'Test')</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;  # becomes</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;  out_record &lt;- wrapr::qchar_frame(</span>
<span class="co">#&gt;    &quot;ID&quot;  , &quot;Year&quot;, &quot;Time&quot;  , &quot;Test1&quot;, &quot;Test2&quot; |</span>
<span class="co">#&gt;      .   , .     , &quot;Fall&quot;  , Fall1  , Fall2   |</span>
<span class="co">#&gt;      .   , .     , &quot;Spring&quot;, Spring1, Spring2 |</span>
<span class="co">#&gt;      .   , .     , &quot;Winter&quot;, Winter1, Winter2 )</span>
<span class="co">#&gt;  out_keys &lt;- c('ID', 'Year', 'Time')</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;  # args: c(checkNames = TRUE, checkKeys = TRUE, strict = FALSE, allow_rqdatatable = FALSE)</span>
<span class="co">#&gt; }</span>

<span class="co"># example data</span>
grades &lt;-<span class="st"> </span>wrapr<span class="op">::</span><span class="kw">build_frame</span>(
   <span class="st">&quot;ID&quot;</span>  , <span class="st">&quot;Test&quot;</span>, <span class="st">&quot;Year&quot;</span>, <span class="st">&quot;Fall&quot;</span>, <span class="st">&quot;Spring&quot;</span>, <span class="st">&quot;Winter&quot;</span> <span class="op">|</span>
<span class="st">     </span><span class="dv">1</span>   , <span class="dv">1</span>     , <span class="dv">2008</span>  , <span class="dv">15</span>    , <span class="dv">16</span>      , <span class="dv">19</span>       <span class="op">|</span>
<span class="st">     </span><span class="dv">1</span>   , <span class="dv">1</span>     , <span class="dv">2009</span>  , <span class="dv">12</span>    , <span class="dv">13</span>      , <span class="dv">27</span>       <span class="op">|</span>
<span class="st">     </span><span class="dv">1</span>   , <span class="dv">2</span>     , <span class="dv">2008</span>  , <span class="dv">22</span>    , <span class="dv">22</span>      , <span class="dv">24</span>       <span class="op">|</span>
<span class="st">     </span><span class="dv">1</span>   , <span class="dv">2</span>     , <span class="dv">2009</span>  , <span class="dv">10</span>    , <span class="dv">14</span>      , <span class="dv">20</span>       <span class="op">|</span>
<span class="st">     </span><span class="dv">2</span>   , <span class="dv">1</span>     , <span class="dv">2008</span>  , <span class="dv">12</span>    , <span class="dv">13</span>      , <span class="dv">25</span>       <span class="op">|</span>
<span class="st">     </span><span class="dv">2</span>   , <span class="dv">1</span>     , <span class="dv">2009</span>  , <span class="dv">16</span>    , <span class="dv">14</span>      , <span class="dv">21</span>       <span class="op">|</span>
<span class="st">     </span><span class="dv">2</span>   , <span class="dv">2</span>     , <span class="dv">2008</span>  , <span class="dv">13</span>    , <span class="dv">11</span>      , <span class="dv">29</span>       <span class="op">|</span>
<span class="st">     </span><span class="dv">2</span>   , <span class="dv">2</span>     , <span class="dv">2009</span>  , <span class="dv">23</span>    , <span class="dv">20</span>      , <span class="dv">26</span>       <span class="op">|</span>
<span class="st">     </span><span class="dv">3</span>   , <span class="dv">1</span>     , <span class="dv">2008</span>  , <span class="dv">11</span>    , <span class="dv">12</span>      , <span class="dv">22</span>       <span class="op">|</span>
<span class="st">     </span><span class="dv">3</span>   , <span class="dv">1</span>     , <span class="dv">2009</span>  , <span class="dv">13</span>    , <span class="dv">11</span>      , <span class="dv">27</span>       <span class="op">|</span>
<span class="st">     </span><span class="dv">3</span>   , <span class="dv">2</span>     , <span class="dv">2008</span>  , <span class="dv">17</span>    , <span class="dv">12</span>      , <span class="dv">23</span>       <span class="op">|</span>
<span class="st">     </span><span class="dv">3</span>   , <span class="dv">2</span>     , <span class="dv">2009</span>  , <span class="dv">14</span>    ,  <span class="dv">9</span>      , <span class="dv">31</span>       )

<span class="co"># apply the layout</span>
grades <span class="op">%.&gt;%</span><span class="st"> </span>
<span class="st">  </span>layout <span class="op">%.&gt;%</span>
<span class="st">  </span>knitr<span class="op">::</span><span class="kw">kable</span>(.)</code></pre></div>
<table>
<thead>
<tr class="header">
<th align="right">ID</th>
<th align="right">Year</th>
<th align="left">Time</th>
<th align="right">Test1</th>
<th align="right">Test2</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="right">2008</td>
<td align="left">Fall</td>
<td align="right">15</td>
<td align="right">22</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">2008</td>
<td align="left">Spring</td>
<td align="right">16</td>
<td align="right">22</td>
</tr>
<tr class="odd">
<td align="right">1</td>
<td align="right">2008</td>
<td align="left">Winter</td>
<td align="right">19</td>
<td align="right">24</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">2009</td>
<td align="left">Fall</td>
<td align="right">12</td>
<td align="right">10</td>
</tr>
<tr class="odd">
<td align="right">1</td>
<td align="right">2009</td>
<td align="left">Spring</td>
<td align="right">13</td>
<td align="right">14</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">2009</td>
<td align="left">Winter</td>
<td align="right">27</td>
<td align="right">20</td>
</tr>
<tr class="odd">
<td align="right">2</td>
<td align="right">2008</td>
<td align="left">Fall</td>
<td align="right">12</td>
<td align="right">13</td>
</tr>
<tr class="even">
<td align="right">2</td>
<td align="right">2008</td>
<td align="left">Spring</td>
<td align="right">13</td>
<td align="right">11</td>
</tr>
<tr class="odd">
<td align="right">2</td>
<td align="right">2008</td>
<td align="left">Winter</td>
<td align="right">25</td>
<td align="right">29</td>
</tr>
<tr class="even">
<td align="right">2</td>
<td align="right">2009</td>
<td align="left">Fall</td>
<td align="right">16</td>
<td align="right">23</td>
</tr>
<tr class="odd">
<td align="right">2</td>
<td align="right">2009</td>
<td align="left">Spring</td>
<td align="right">14</td>
<td align="right">20</td>
</tr>
<tr class="even">
<td align="right">2</td>
<td align="right">2009</td>
<td align="left">Winter</td>
<td align="right">21</td>
<td align="right">26</td>
</tr>
<tr class="odd">
<td align="right">3</td>
<td align="right">2008</td>
<td align="left">Fall</td>
<td align="right">11</td>
<td align="right">17</td>
</tr>
<tr class="even">
<td align="right">3</td>
<td align="right">2008</td>
<td align="left">Spring</td>
<td align="right">12</td>
<td align="right">12</td>
</tr>
<tr class="odd">
<td align="right">3</td>
<td align="right">2008</td>
<td align="left">Winter</td>
<td align="right">22</td>
<td align="right">23</td>
</tr>
<tr class="even">
<td align="right">3</td>
<td align="right">2009</td>
<td align="left">Fall</td>
<td align="right">13</td>
<td align="right">14</td>
</tr>
<tr class="odd">
<td align="right">3</td>
<td align="right">2009</td>
<td align="left">Spring</td>
<td align="right">11</td>
<td align="right">9</td>
</tr>
<tr class="even">
<td align="right">3</td>
<td align="right">2009</td>
<td align="left">Winter</td>
<td align="right">27</td>
<td align="right">31</td>
</tr>
</tbody>
</table>
</div>
<div id="example-3" class="section level1">
<h1>Example 3</h1>
<p>(From: <a href="https://github.com/tidyverse/tidyr/blob/master/demo/so-16032858.R" class="uri">https://github.com/tidyverse/tidyr/blob/master/demo/so-16032858.R</a> , <a href="http://stackoverflow.com/questions/16032858" class="uri">http://stackoverflow.com/questions/16032858</a>.)</p>
<p>Question: given data such as below how does one move treatment and control values for each individual into columns? Or how does one take <code>a</code> to <code>b</code>?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">a &lt;-<span class="st"> </span>wrapr<span class="op">::</span><span class="kw">build_frame</span>(
   <span class="st">&quot;Ind&quot;</span>   , <span class="st">&quot;Treatment&quot;</span>, <span class="st">&quot;value&quot;</span> <span class="op">|</span>
<span class="st">     &quot;Ind1&quot;</span>, <span class="st">&quot;Treat&quot;</span>    , <span class="dv">1</span>       <span class="op">|</span>
<span class="st">     &quot;Ind2&quot;</span>, <span class="st">&quot;Treat&quot;</span>    , <span class="dv">2</span>       <span class="op">|</span>
<span class="st">     &quot;Ind1&quot;</span>, <span class="st">&quot;Cont&quot;</span>     , <span class="dv">3</span>       <span class="op">|</span>
<span class="st">     &quot;Ind2&quot;</span>, <span class="st">&quot;Cont&quot;</span>     , <span class="dv">4</span>       )

b &lt;-<span class="st"> </span>wrapr<span class="op">::</span><span class="kw">build_frame</span>(
   <span class="st">&quot;Ind&quot;</span>   , <span class="st">&quot;Treat&quot;</span> , <span class="st">&quot;Cont&quot;</span><span class="op">|</span>
<span class="st">     &quot;Ind1&quot;</span>, <span class="dv">1</span>       , <span class="dv">3</span>     <span class="op">|</span>
<span class="st">     &quot;Ind2&quot;</span>, <span class="dv">2</span>       , <span class="dv">4</span>     )</code></pre></div>
<p>In this case, a record corresponds to an individual, and the outgoing data is in row record form:</p>
<table>
<thead>
<tr class="header">
<th align="left">Ind</th>
<th align="right">Treat</th>
<th align="right">Cont</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Ind1</td>
<td align="right">1</td>
<td align="right">3</td>
</tr>
</tbody>
</table>
<p>That means we will use <code>blocks_to_rowrecs_spec()</code>.</p>
<p>The <code>cdata</code> solution is as follows.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&quot;cdata&quot;</span>)

<span class="co"># identify the record key</span>
recordKeys &lt;-<span class="st"> &quot;Ind&quot;</span>

<span class="co"># specify the incoming record shape</span>
incoming_record &lt;-<span class="st"> </span>wrapr<span class="op">::</span><span class="kw">qchar_frame</span>(
   <span class="st">&quot;Treatment&quot;</span>  , <span class="st">&quot;value&quot;</span> <span class="op">|</span>
<span class="st">    &quot;Treat&quot;</span>     , Treat   <span class="op">|</span>
<span class="st">    &quot;Cont&quot;</span>      , Cont    )


<span class="co"># put it all together into a layout</span>
layout &lt;-<span class="st"> </span><span class="kw">blocks_to_rowrecs_spec</span>(
  incoming_record,
  <span class="dt">recordKeys =</span> recordKeys)

<span class="co"># confirm we have the right layout</span>
<span class="kw">print</span>(layout)
<span class="co">#&gt; {</span>
<span class="co">#&gt;  block_record &lt;- wrapr::qchar_frame(</span>
<span class="co">#&gt;    &quot;Ind&quot;  , &quot;Treatment&quot;, &quot;value&quot; |</span>
<span class="co">#&gt;      .    , &quot;Treat&quot;    , Treat   |</span>
<span class="co">#&gt;      .    , &quot;Cont&quot;     , Cont    )</span>
<span class="co">#&gt;  block_keys &lt;- c('Ind', 'Treatment')</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;  # becomes</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;  row_record &lt;- wrapr::qchar_frame(</span>
<span class="co">#&gt;    &quot;Ind&quot;  , &quot;Treat&quot;, &quot;Cont&quot; |</span>
<span class="co">#&gt;      .    , Treat  , Cont   )</span>
<span class="co">#&gt;  row_keys &lt;- c('Ind')</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;  # args: c(checkNames = TRUE, checkKeys = TRUE, strict = FALSE, allow_rqdatatable = FALSE)</span>
<span class="co">#&gt; }</span>

<span class="co"># apply the layout</span>
a <span class="op">%.&gt;%</span><span class="st"> </span>
<span class="st">  </span>layout <span class="op">%.&gt;%</span>
<span class="st">  </span>knitr<span class="op">::</span><span class="kw">kable</span>(.)</code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">Ind</th>
<th align="right">Treat</th>
<th align="right">Cont</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Ind1</td>
<td align="right">1</td>
<td align="right">3</td>
</tr>
<tr class="even">
<td align="left">Ind2</td>
<td align="right">2</td>
<td align="right">4</td>
</tr>
</tbody>
</table>
<p>This particular transform, from a block consisting of a single column of values (and the rest of the columns being keys) to a row record, is the transform typically referred to as <em>spread</em>, <em>dcast</em>, or <em>pivot</em>. The <code>tidyr</code> package has a convenient call for this transform: <code>spread()</code>; <code>cdata</code> also has a similar convenience call: <code>pivot_to_rowrecs()</code>.</p>
<p>Don’t worry if you didn’t notice that this example is a spread; one of the values of <code>cdata</code> is that you shouldn’t have to think about it. Most of the examples we show here are neither a simple spread/pivot nor a simple gather/unpivot.</p>
<p>By now you should be able to see the <code>cdata</code> solution always follows a very similar path. We try not to let the nature of the data layout transform (“easy” versus “hard”) dictate the solution method. Always slow down and draw out the “before” and “after” shapes before attempting to solve the problem.</p>
</div>
<div id="example-4" class="section level1">
<h1>Example 4</h1>
<p>(From: <a href="https://github.com/tidyverse/tidyr/blob/master/demo/so-17481212.R" class="uri">https://github.com/tidyverse/tidyr/blob/master/demo/so-17481212.R</a> , <a href="http://stackoverflow.com/questions/17481212" class="uri">http://stackoverflow.com/questions/17481212</a>.)</p>
<p>Convert data that has one different observation for each column to a data that has all observations in rows. That is take <code>a</code> to <code>b</code> in the following.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">a &lt;-<span class="st"> </span>wrapr<span class="op">::</span><span class="kw">build_frame</span>(
   <span class="st">&quot;Name&quot;</span>   , <span class="st">&quot;50&quot;</span>, <span class="st">&quot;100&quot;</span>, <span class="st">&quot;150&quot;</span>, <span class="st">&quot;200&quot;</span>, <span class="st">&quot;250&quot;</span>, <span class="st">&quot;300&quot;</span>, <span class="st">&quot;350&quot;</span> <span class="op">|</span>
<span class="st">     &quot;Carla&quot;</span>, <span class="fl">1.2</span> , <span class="fl">1.8</span>  , <span class="fl">2.2</span>  , <span class="fl">2.3</span>  , <span class="dv">3</span>    , <span class="fl">2.5</span>  , <span class="fl">1.8</span>   <span class="op">|</span>
<span class="st">     &quot;Mace&quot;</span> , <span class="fl">1.5</span> , <span class="fl">1.1</span>  , <span class="fl">1.9</span>  , <span class="dv">2</span>    , <span class="fl">3.6</span>  , <span class="dv">3</span>    , <span class="fl">2.5</span>   )

b &lt;-<span class="st"> </span>wrapr<span class="op">::</span><span class="kw">build_frame</span>(
   <span class="st">&quot;Name&quot;</span>   , <span class="st">&quot;Time&quot;</span>, <span class="st">&quot;Score&quot;</span> <span class="op">|</span>
<span class="st">     &quot;Carla&quot;</span>, <span class="dv">50</span>    , <span class="fl">1.2</span>     <span class="op">|</span>
<span class="st">     &quot;Carla&quot;</span>, <span class="dv">100</span>   , <span class="fl">1.8</span>     <span class="op">|</span>
<span class="st">     &quot;Carla&quot;</span>, <span class="dv">150</span>   , <span class="fl">2.2</span>     <span class="op">|</span>
<span class="st">     &quot;Carla&quot;</span>, <span class="dv">200</span>   , <span class="fl">2.3</span>     <span class="op">|</span>
<span class="st">     &quot;Carla&quot;</span>, <span class="dv">250</span>   , <span class="dv">3</span>       <span class="op">|</span>
<span class="st">     &quot;Carla&quot;</span>, <span class="dv">300</span>   , <span class="fl">2.5</span>     <span class="op">|</span>
<span class="st">     &quot;Carla&quot;</span>, <span class="dv">350</span>   , <span class="fl">1.8</span>     <span class="op">|</span>
<span class="st">     &quot;Mace&quot;</span> , <span class="dv">50</span>    , <span class="fl">1.5</span>     <span class="op">|</span>
<span class="st">     &quot;Mace&quot;</span> , <span class="dv">100</span>   , <span class="fl">1.1</span>     <span class="op">|</span>
<span class="st">     &quot;Mace&quot;</span> , <span class="dv">150</span>   , <span class="fl">1.9</span>     <span class="op">|</span>
<span class="st">     &quot;Mace&quot;</span> , <span class="dv">200</span>   , <span class="dv">2</span>       <span class="op">|</span>
<span class="st">     &quot;Mace&quot;</span> , <span class="dv">250</span>   , <span class="fl">3.6</span>     <span class="op">|</span>
<span class="st">     &quot;Mace&quot;</span> , <span class="dv">300</span>   , <span class="dv">3</span>       <span class="op">|</span>
<span class="st">     &quot;Mace&quot;</span> , <span class="dv">350</span>   , <span class="fl">2.5</span>     )</code></pre></div>
<p>Here a record corresponds to a single observation (keyed by <code>Name</code>), and the incoming data is arranged in row records:</p>
<table>
<thead>
<tr class="header">
<th align="left">Name</th>
<th align="right">50</th>
<th align="right">100</th>
<th align="right">150</th>
<th align="right">200</th>
<th align="right">250</th>
<th align="right">300</th>
<th align="right">350</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Carla</td>
<td align="right">1.2</td>
<td align="right">1.8</td>
<td align="right">2.2</td>
<td align="right">2.3</td>
<td align="right">3</td>
<td align="right">2.5</td>
<td align="right">1.8</td>
</tr>
</tbody>
</table>
<p>This particular transformation, from a single row of values to a single column of values (with multiple key columns), is the transform commonly called <em>gather</em>, <em>melt</em>, or <em>unpivot</em>. This is a very common transformation—probably the most common one, by far. Again, <code>cdata</code> has a convenience function, <code>pivot_to_blocks()</code> (or its alias <code>unpivot_to_blocks()</code>).</p>
<p>Here, we will do the transform “the long way” with <code>rowrecs_to_blocks_spec()</code>. As we have a large number of columns we will use a helper function to specify the data layout transform.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&quot;cdata&quot;</span>)

<span class="co"># how to find records</span>
recordKeys &lt;-<span class="st"> &quot;Name&quot;</span>

<span class="co"># specify the outgoing record shape, using a helper function</span>
<span class="co"># (and print it --  notice that it's a data frame)</span>
( outgoing_record &lt;-<span class="st"> </span><span class="kw">build_unpivot_control</span>(
  <span class="dt">nameForNewKeyColumn =</span> <span class="st">&quot;Time&quot;</span>,
  <span class="dt">nameForNewValueColumn =</span> <span class="st">&quot;Score&quot;</span>,
  <span class="dt">columnsToTakeFrom =</span> <span class="kw">setdiff</span>(<span class="kw">colnames</span>(a), recordKeys)) )
<span class="co">#&gt;   Time Score</span>
<span class="co">#&gt; 1   50    50</span>
<span class="co">#&gt; 2  100   100</span>
<span class="co">#&gt; 3  150   150</span>
<span class="co">#&gt; 4  200   200</span>
<span class="co">#&gt; 5  250   250</span>
<span class="co">#&gt; 6  300   300</span>
<span class="co">#&gt; 7  350   350</span>

<span class="co"># put it all together into a layout</span>
layout &lt;-<span class="st"> </span><span class="kw">rowrecs_to_blocks_spec</span>(
  outgoing_record,
  <span class="dt">recordKeys =</span> recordKeys)

<span class="co"># confirm we have the right layout</span>
<span class="kw">print</span>(layout)
<span class="co">#&gt; {</span>
<span class="co">#&gt;  row_record &lt;- wrapr::qchar_frame(</span>
<span class="co">#&gt;    &quot;Name&quot;  , &quot;50&quot;, &quot;100&quot;, &quot;150&quot;, &quot;200&quot;, &quot;250&quot;, &quot;300&quot;, &quot;350&quot; |</span>
<span class="co">#&gt;      .     , 50  , 100  , 150  , 200  , 250  , 300  , 350   )</span>
<span class="co">#&gt;  row_keys &lt;- c('Name')</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;  # becomes</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;  block_record &lt;- wrapr::qchar_frame(</span>
<span class="co">#&gt;    &quot;Name&quot;  , &quot;Time&quot;, &quot;Score&quot; |</span>
<span class="co">#&gt;      .     , &quot;50&quot;  , 50      |</span>
<span class="co">#&gt;      .     , &quot;100&quot; , 100     |</span>
<span class="co">#&gt;      .     , &quot;150&quot; , 150     |</span>
<span class="co">#&gt;      .     , &quot;200&quot; , 200     |</span>
<span class="co">#&gt;      .     , &quot;250&quot; , 250     |</span>
<span class="co">#&gt;      .     , &quot;300&quot; , 300     |</span>
<span class="co">#&gt;      .     , &quot;350&quot; , 350     )</span>
<span class="co">#&gt;  block_keys &lt;- c('Name', 'Time')</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;  # args: c(checkNames = TRUE, checkKeys = FALSE, strict = FALSE, allow_rqdatatable = TRUE)</span>
<span class="co">#&gt; }</span>

<span class="co"># apply the layout</span>
a <span class="op">%.&gt;%</span><span class="st"> </span>
<span class="st">  </span>layout <span class="op">%.&gt;%</span>
<span class="st">  </span><span class="kw">transform</span>(., <span class="dt">Time =</span> <span class="kw">as.numeric</span>(Time)) <span class="op">%.&gt;%</span>
<span class="st">  </span><span class="co"># sort the data frame by Name and then Time</span>
<span class="st">  </span>.[<span class="kw">order</span>(.<span class="op">$</span>Name, .<span class="op">$</span>Time), , drop =<span class="st"> </span><span class="ot">FALSE</span>] <span class="op">%.&gt;%</span>
<span class="st">  </span>knitr<span class="op">::</span><span class="kw">kable</span>(., <span class="dt">row.names =</span> <span class="ot">FALSE</span>)</code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">Name</th>
<th align="right">Time</th>
<th align="right">Score</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Carla</td>
<td align="right">50</td>
<td align="right">1.2</td>
</tr>
<tr class="even">
<td align="left">Carla</td>
<td align="right">100</td>
<td align="right">1.8</td>
</tr>
<tr class="odd">
<td align="left">Carla</td>
<td align="right">150</td>
<td align="right">2.2</td>
</tr>
<tr class="even">
<td align="left">Carla</td>
<td align="right">200</td>
<td align="right">2.3</td>
</tr>
<tr class="odd">
<td align="left">Carla</td>
<td align="right">250</td>
<td align="right">3.0</td>
</tr>
<tr class="even">
<td align="left">Carla</td>
<td align="right">300</td>
<td align="right">2.5</td>
</tr>
<tr class="odd">
<td align="left">Carla</td>
<td align="right">350</td>
<td align="right">1.8</td>
</tr>
<tr class="even">
<td align="left">Mace</td>
<td align="right">50</td>
<td align="right">1.5</td>
</tr>
<tr class="odd">
<td align="left">Mace</td>
<td align="right">100</td>
<td align="right">1.1</td>
</tr>
<tr class="even">
<td align="left">Mace</td>
<td align="right">150</td>
<td align="right">1.9</td>
</tr>
<tr class="odd">
<td align="left">Mace</td>
<td align="right">200</td>
<td align="right">2.0</td>
</tr>
<tr class="even">
<td align="left">Mace</td>
<td align="right">250</td>
<td align="right">3.6</td>
</tr>
<tr class="odd">
<td align="left">Mace</td>
<td align="right">300</td>
<td align="right">3.0</td>
</tr>
<tr class="even">
<td align="left">Mace</td>
<td align="right">350</td>
<td align="right">2.5</td>
</tr>
</tbody>
</table>
</div>
<div id="example-5" class="section level1">
<h1>Example 5</h1>
<p>(From: <a href="https://github.com/tidyverse/tidyr/blob/master/demo/so-9684671.R" class="uri">https://github.com/tidyverse/tidyr/blob/master/demo/so-9684671.R</a> , <a href="http://stackoverflow.com/questions/9684671" class="uri">http://stackoverflow.com/questions/9684671</a>.)</p>
<p>Convert from <code>a</code> to <code>b</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">a &lt;-<span class="st"> </span>wrapr<span class="op">::</span><span class="kw">build_frame</span>(
   <span class="st">&quot;id&quot;</span>    , <span class="st">&quot;trt&quot;</span>, <span class="st">&quot;work.T1&quot;</span>, <span class="st">&quot;play.T1&quot;</span>, <span class="st">&quot;talk.T1&quot;</span>, <span class="st">&quot;total.T1&quot;</span>, <span class="st">&quot;work.T2&quot;</span>, <span class="st">&quot;play.T2&quot;</span>, <span class="st">&quot;talk.T2&quot;</span>, <span class="st">&quot;total.T2&quot;</span> <span class="op">|</span>
<span class="st">     &quot;x1.1&quot;</span>, <span class="st">&quot;cnt&quot;</span>, <span class="fl">0.3443</span>   , <span class="fl">0.7842</span>   , <span class="fl">0.1079</span>   , <span class="fl">0.888</span>     , <span class="fl">0.6484</span>   , <span class="fl">0.8795</span>   , <span class="fl">0.7234</span>   , <span class="fl">0.5631</span>     <span class="op">|</span>
<span class="st">     &quot;x1.2&quot;</span>, <span class="st">&quot;tr&quot;</span> , <span class="fl">0.06132</span>  , <span class="fl">0.8427</span>   , <span class="fl">0.3339</span>   , <span class="fl">0.04686</span>   , <span class="fl">0.2348</span>   , <span class="fl">0.1971</span>   , <span class="fl">0.5164</span>   , <span class="fl">0.7618</span>     )

b &lt;-<span class="st"> </span>wrapr<span class="op">::</span><span class="kw">build_frame</span>(
   <span class="st">&quot;id&quot;</span>    , <span class="st">&quot;trt&quot;</span>, <span class="st">&quot;time&quot;</span>, <span class="st">&quot;work&quot;</span> , <span class="st">&quot;play&quot;</span>, <span class="st">&quot;talk&quot;</span>, <span class="st">&quot;total&quot;</span> <span class="op">|</span>
<span class="st">     &quot;x1.1&quot;</span>, <span class="st">&quot;cnt&quot;</span>, <span class="st">&quot;T1&quot;</span>  , <span class="fl">0.3443</span> , <span class="fl">0.7842</span>, <span class="fl">0.1079</span>, <span class="fl">0.888</span>   <span class="op">|</span>
<span class="st">     &quot;x1.1&quot;</span>, <span class="st">&quot;cnt&quot;</span>, <span class="st">&quot;T2&quot;</span>  , <span class="fl">0.6484</span> , <span class="fl">0.8795</span>, <span class="fl">0.7234</span>, <span class="fl">0.5631</span>  <span class="op">|</span>
<span class="st">     &quot;x1.2&quot;</span>, <span class="st">&quot;tr&quot;</span> , <span class="st">&quot;T1&quot;</span>  , <span class="fl">0.06132</span>, <span class="fl">0.8427</span>, <span class="fl">0.3339</span>, <span class="fl">0.04686</span> <span class="op">|</span>
<span class="st">     &quot;x1.2&quot;</span>, <span class="st">&quot;tr&quot;</span> , <span class="st">&quot;T2&quot;</span>  , <span class="fl">0.2348</span> , <span class="fl">0.1971</span>, <span class="fl">0.5164</span>, <span class="fl">0.7618</span>  )</code></pre></div>
<p>A record is an observation, keyed by <code>id</code> (plus <code>trt</code>, which is a function of <code>id</code>).</p>
<table>
<thead>
<tr class="header">
<th align="left">id</th>
<th align="left">trt</th>
<th align="right">work.T1</th>
<th align="right">play.T1</th>
<th align="right">talk.T1</th>
<th align="right">total.T1</th>
<th align="right">work.T2</th>
<th align="right">play.T2</th>
<th align="right">talk.T2</th>
<th align="right">total.T2</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">x1.1</td>
<td align="left">cnt</td>
<td align="right">0.3443</td>
<td align="right">0.7842</td>
<td align="right">0.1079</td>
<td align="right">0.888</td>
<td align="right">0.6484</td>
<td align="right">0.8795</td>
<td align="right">0.7234</td>
<td align="right">0.5631</td>
</tr>
</tbody>
</table>
<p>The incoming data is in row record format, so we can use <code>rowrecs_to_blocks_spec()</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&quot;cdata&quot;</span>)

<span class="co"># identify the record keys</span>
recordKeys &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;id&quot;</span>, <span class="st">&quot;trt&quot;</span>)

<span class="co"># specify the outgoing record shape</span>
outgoing_record &lt;-<span class="st"> </span>wrapr<span class="op">::</span><span class="kw">qchar_frame</span>(
    <span class="st">&quot;time&quot;</span>  , <span class="st">&quot;work&quot;</span> , <span class="st">&quot;play&quot;</span> , <span class="st">&quot;talk&quot;</span> , <span class="st">&quot;total&quot;</span>  <span class="op">|</span>
<span class="st">    &quot;T1&quot;</span>    , work.T1, play.T1, talk.T1, total.T1 <span class="op">|</span>
<span class="st">    &quot;T2&quot;</span>    , work.T2, play.T2, talk.T2, total.T2 )

<span class="co"># put it all together into a layout</span>
layout &lt;-<span class="st"> </span><span class="kw">rowrecs_to_blocks_spec</span>(
  outgoing_record,
  <span class="dt">recordKeys =</span> recordKeys)

<span class="co"># confirm we have the right layout</span>
<span class="kw">print</span>(layout)
<span class="co">#&gt; {</span>
<span class="co">#&gt;  row_record &lt;- wrapr::qchar_frame(</span>
<span class="co">#&gt;    &quot;id&quot;  , &quot;trt&quot;, &quot;work.T1&quot;, &quot;work.T2&quot;, &quot;play.T1&quot;, &quot;play.T2&quot;, &quot;talk.T1&quot;, &quot;talk.T2&quot;, &quot;total.T1&quot;, &quot;total.T2&quot; |</span>
<span class="co">#&gt;      .   , .    , work.T1  , work.T2  , play.T1  , play.T2  , talk.T1  , talk.T2  , total.T1  , total.T2   )</span>
<span class="co">#&gt;  row_keys &lt;- c('id', 'trt')</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;  # becomes</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;  block_record &lt;- wrapr::qchar_frame(</span>
<span class="co">#&gt;    &quot;id&quot;  , &quot;trt&quot;, &quot;time&quot;, &quot;work&quot; , &quot;play&quot; , &quot;talk&quot; , &quot;total&quot;  |</span>
<span class="co">#&gt;      .   , .    , &quot;T1&quot;  , work.T1, play.T1, talk.T1, total.T1 |</span>
<span class="co">#&gt;      .   , .    , &quot;T2&quot;  , work.T2, play.T2, talk.T2, total.T2 )</span>
<span class="co">#&gt;  block_keys &lt;- c('id', 'trt', 'time')</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;  # args: c(checkNames = TRUE, checkKeys = FALSE, strict = FALSE, allow_rqdatatable = TRUE)</span>
<span class="co">#&gt; }</span>

<span class="co"># apply the layout</span>
a <span class="op">%.&gt;%</span><span class="st"> </span>
<span class="st">  </span>layout <span class="op">%.&gt;%</span>
<span class="st">  </span><span class="co"># reorder the frame by the record keys plus time</span>
<span class="st">  </span>.[wrapr<span class="op">::</span><span class="kw">orderv</span>(.[ , <span class="kw">c</span>(recordKeys, <span class="st">&quot;time&quot;</span>), <span class="dt">drop =</span> <span class="ot">FALSE</span>]), , drop =<span class="st"> </span><span class="ot">FALSE</span>] <span class="op">%.&gt;%</span>
<span class="st">  </span>knitr<span class="op">::</span><span class="kw">kable</span>(., <span class="dt">row.names =</span> <span class="ot">FALSE</span>)</code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">id</th>
<th align="left">trt</th>
<th align="left">time</th>
<th align="right">work</th>
<th align="right">play</th>
<th align="right">talk</th>
<th align="right">total</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">x1.1</td>
<td align="left">cnt</td>
<td align="left">T1</td>
<td align="right">0.34430</td>
<td align="right">0.7842</td>
<td align="right">0.1079</td>
<td align="right">0.88800</td>
</tr>
<tr class="even">
<td align="left">x1.1</td>
<td align="left">cnt</td>
<td align="left">T2</td>
<td align="right">0.64840</td>
<td align="right">0.8795</td>
<td align="right">0.7234</td>
<td align="right">0.56310</td>
</tr>
<tr class="odd">
<td align="left">x1.2</td>
<td align="left">tr</td>
<td align="left">T1</td>
<td align="right">0.06132</td>
<td align="right">0.8427</td>
<td align="right">0.3339</td>
<td align="right">0.04686</td>
</tr>
<tr class="even">
<td align="left">x1.2</td>
<td align="left">tr</td>
<td align="left">T2</td>
<td align="right">0.23480</td>
<td align="right">0.1971</td>
<td align="right">0.5164</td>
<td align="right">0.76180</td>
</tr>
</tbody>
</table>
<div id="reversing-transforms" class="section level2">
<h2>Reversing Transforms</h2>
<p><code>cdata</code> transform specifications are usually reversible or invertible (and this can be enforced). So in solving any one of the above problems the user has complete freedom to try and solve “moving from a to b” or “moving from b to a” (and can pick whichever they find easier).</p>
<p>For example continuing with example 5, we can reverse the data layout transform using the <code>t()</code> function.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">inv_layout &lt;-<span class="st"> </span><span class="kw">t</span>(layout)

<span class="kw">print</span>(inv_layout)
<span class="co">#&gt; {</span>
<span class="co">#&gt;  block_record &lt;- wrapr::qchar_frame(</span>
<span class="co">#&gt;    &quot;id&quot;  , &quot;trt&quot;, &quot;time&quot;, &quot;work&quot; , &quot;play&quot; , &quot;talk&quot; , &quot;total&quot;  |</span>
<span class="co">#&gt;      .   , .    , &quot;T1&quot;  , work.T1, play.T1, talk.T1, total.T1 |</span>
<span class="co">#&gt;      .   , .    , &quot;T2&quot;  , work.T2, play.T2, talk.T2, total.T2 )</span>
<span class="co">#&gt;  block_keys &lt;- c('id', 'trt', 'time')</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;  # becomes</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;  row_record &lt;- wrapr::qchar_frame(</span>
<span class="co">#&gt;    &quot;id&quot;  , &quot;trt&quot;, &quot;work.T1&quot;, &quot;work.T2&quot;, &quot;play.T1&quot;, &quot;play.T2&quot;, &quot;talk.T1&quot;, &quot;talk.T2&quot;, &quot;total.T1&quot;, &quot;total.T2&quot; |</span>
<span class="co">#&gt;      .   , .    , work.T1  , work.T2  , play.T1  , play.T2  , talk.T1  , talk.T2  , total.T1  , total.T2   )</span>
<span class="co">#&gt;  row_keys &lt;- c('id', 'trt')</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;  # args: c(checkNames = TRUE, checkKeys = FALSE, strict = FALSE, allow_rqdatatable = TRUE)</span>
<span class="co">#&gt; }</span>

<span class="co"># apply the inverse layout</span>
b <span class="op">%.&gt;%</span><span class="st"> </span>
<span class="st">  </span>inv_layout <span class="op">%.&gt;%</span>
<span class="st">  </span>knitr<span class="op">::</span><span class="kw">kable</span>(.)</code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">id</th>
<th align="left">trt</th>
<th align="right">work.T1</th>
<th align="right">work.T2</th>
<th align="right">play.T1</th>
<th align="right">play.T2</th>
<th align="right">talk.T1</th>
<th align="right">talk.T2</th>
<th align="right">total.T1</th>
<th align="right">total.T2</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">x1.1</td>
<td align="left">cnt</td>
<td align="right">0.34430</td>
<td align="right">0.6484</td>
<td align="right">0.7842</td>
<td align="right">0.8795</td>
<td align="right">0.1079</td>
<td align="right">0.7234</td>
<td align="right">0.88800</td>
<td align="right">0.5631</td>
</tr>
<tr class="even">
<td align="left">x1.2</td>
<td align="left">tr</td>
<td align="right">0.06132</td>
<td align="right">0.2348</td>
<td align="right">0.8427</td>
<td align="right">0.1971</td>
<td align="right">0.3339</td>
<td align="right">0.5164</td>
<td align="right">0.04686</td>
<td align="right">0.7618</td>
</tr>
</tbody>
</table>
<p>In this case, the inverse transform recovered the original row and column order of <code>a</code>, but this is not guaranteed.</p>
</div>
<div id="package-entry-points" class="section level2">
<h2>Package entry points</h2>
<p>The main <code>cdata</code> interfaces are given by the following set of methods:</p>
<ul>
<li><a href="https://winvector.github.io/cdata/reference/rowrecs_to_blocks_spec.html"><code>rowrecs_to_blocks_spec()</code></a>, for specifying how single row records map to general multi-row (or block) records.</li>
<li><a href="https://winvector.github.io/cdata/reference/blocks_to_rowrecs_spec.html"><code>blocks_to_rowrecs_spec()</code></a>, for specifying how multi-row block records map to single-row records.</li>
<li><a href="https://winvector.github.io/cdata/reference/layout_specification.html"><code>layout_specification()</code></a>, for specifying transforms from multi-row records to other multi-row records.</li>
<li><a href="https://winvector.github.io/cdata/reference/layout_by.html"><code>layout_by()</code></a> or the <a href="https://winvector.github.io/wrapr/reference/dot_arrow.html">wrapr dot arrow pipe</a> for applying a layout to re-arrange data.</li>
<li><code>t()</code> (transpose/adjoint) to invert or reverse layout specifications.</li>
</ul>
<p>Some convenience functions include:</p>
<ul>
<li><a href="https://winvector.github.io/cdata/reference/pivot_to_rowrecs.html"><code>pivot_to_rowrecs()</code></a>, for moving data from multi-row block records with one value per row (a single column of values) to single-row records [<code>spread</code> or <code>dcast</code>].</li>
<li><a href="https://winvector.github.io/cdata/reference/unpivot_to_blocks.html"><code>pivot_to_blocks()</code>/<code>unpivot_to_blocks()</code></a>, for moving data from single-row records to possibly multi row block records with one row per value (a single column of values) [<code>gather</code> or <code>melt</code>].</li>
<li><a href="https://winvector.github.io/wrapr/reference/qchar_frame.html"><code>wrapr::qchar_frame()</code></a> a helper function for specifying record control table layout specifications.</li>
<li><a href="https://winvector.github.io/wrapr/reference/build_frame.html"><code>wrapr::build_frame()</code></a> a helper function for specifying data frames.</li>
</ul>
<p>The package vignettes can be found in the “Articles” tab of <a href="https://winvector.github.io/cdata/">the <code>cdata</code> documentation site</a>.</p>
</div>
<div id="conclusion" class="section level2">
<h2>Conclusion</h2>
<p>The key step in using <code>cdata</code> is to understand the record structure: what constitutes a record, what it would look like in a single row, and how the records are keyed. <strong>This is not always easy.</strong> However, understanding your data record layout <em>is</em> worth the effort. Once you understand the record structure of your data, the rest is relatively straightforward. Really all one is doing when using <code>cdata</code> is formalizing the transform “ask” into a machine readable example.</p>
<p>To make your own solutions, we suggest trying one of the above example solutions as a template. The idea of having the data layout transform be simple data (a <code>list</code> of a couple of <code>data.frame</code>s) means one can use the full power of <code>R</code> and other <code>R</code> packages to build the data layout transform specification (one isn’t limited to some interface grammar specified by the data layout transform package). The idea of using arbitrary code to build up a data layout transform was used to good end in the grid scatter-plot example <a href="https://github.com/WinVector/cdata">here</a>.</p>
<p>We also note the value of being able to print and review the bulk of data layout transform, as it documents expected incoming data columns and interior block record key values.</p>
</div>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>

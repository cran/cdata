<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="John Mount, Nina Zumel; Win-Vector LLC" />

<meta name="date" content="2023-08-19" />

<title>cdata Exercises</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>



<style type="text/css">
code {
white-space: pre;
}
.sourceCode {
overflow: visible;
}
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">cdata Exercises</h1>
<h4 class="author">John Mount, Nina Zumel; Win-Vector LLC</h4>
<h4 class="date">2023-08-19</h4>



<p>In <a href="https://winvector.github.io/cdata/articles/exercises.html">this
note</a> we will use five real life examples to demonstrate data layout
transforms using the <a href="https://CRAN.R-project.org/package=cdata"><code>cdata</code></a>
<a href="https://www.r-project.org"><code>R</code></a> package. The
examples for this note are all demo-examples from <a href="https://github.com/tidyverse/tidyr/tree/0d633f79e85a87a686b2f43de20e2ae74f5c122c/demo">tidyr:demo/</a>
(current when we <a href="https://win-vector.com/2019/04/27/data-layout-exercises/">shared
this note on 2019-04-27</a>, <a href="https://github.com/tidyverse/tidyr/commit/51b2b6ecbe91fcaf0ef3fbc0ef2d9465fbddd0c2">removed
2019-04-28</a>), and are mostly based on questions posted to
StackOverflow. They represent a good cross-section of data layout
problems, so they are a good set of examples or exercises to work
through.</p>
<p>For each of these examples we will show how to re-layout data using
<a href="https://github.com/WinVector/cdata"><code>cdata</code></a>.</p>
<div id="introduction" class="section level2">
<h2>Introduction</h2>
<p>Each of these five problems will be solved using the same steps:</p>
<ul>
<li><p>Examine example input data and desired result data.</p></li>
<li><p>Check if either the incoming or outgoing data format is in
“row-record” format: is all the data for a single record contained in
one row? This determines which data layout transform specification you
will use:</p>
<ul>
<li><code>rowrecs_to_blocks_spec()</code>: To specify data moving from
single rows to arbitrary “block-shaped” records</li>
<li><code>blocks_to_rowrecs_spec()</code>: To specify data moving from
block records to single rows</li>
<li><code>layout_specification()</code>: To specify data moving one
shape of general block record to another block record.</li>
</ul></li>
<li><p>Identify which columns form the record ids (group sets of rows
into records), which we call the “record keys.”</p></li>
<li><p>Draw the shape of the incoming record without the record key
columns.</p></li>
<li><p>Draw the shape of the outgoing record without the record key
columns.</p></li>
<li><p>Combine the above information as one of the above data layout
transform specifications.</p></li>
<li><p>Print the layout transform to confirm it is what you
want.</p></li>
<li><p>Apply the layout transform.</p></li>
</ul>
<p>This may seem like a lot of steps, but it is only because we are
taking the problems very slowly. The important point is that we want to
minimize <em>additional</em> problem solving when applying the
<code>cdata</code> methodology. Usually when you need to transform data
you are in the middle of some other more important task, so you want to
delegate the details of how the layout transform is implemented. With
<code>cdata</code> the user is not asked to perform additional puzzle
solving to guess a sequence of operators that may implement the desired
data layout transform. The <code>cdata</code> solution pattern is always
the same, which can help in mastering it.</p>
<p>With <code>cdata</code>, record layout transforms are simple
<code>R</code> objects with detailed <code>print()</code> methods- so
they are convenient to alter, save, and re-use later. The record layout
transform also documents the expected columns and constants of the
incoming data.</p>
<p>We will work some examples with the hope that practice brings
familiarity. We have some notes on how to graphically solve exercise
like this <a href="https://winvector.github.io/cdata/articles/design.html">here</a>
and <a href="https://win-vector.com/2019/04/16/controlling-data-layout-with-cdata/">here</a>,
but let’s dive into working the exercises.</p>
</div>
<div id="example-1" class="section level2">
<h2>Example 1</h2>
<p>(From: <a href="https://github.com/tidyverse/tidyr/blob/0d633f79e85a87a686b2f43de20e2ae74f5c122c/demo/dadmom.R">tidyr:demo/dadmom.R</a>.)</p>
<p>From <a href="https://stats.oarc.ucla.edu/stata/modules/reshaping-data-wide-to-long/">https://stats.oarc.ucla.edu/stata/modules/reshaping-data-wide-to-long/</a>
we can get get a copy of the data and the question or “transform
ask”:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="co"># convert from this format</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a>dadmomw <span class="ot">&lt;-</span> wrapr<span class="sc">::</span><span class="fu">build_frame</span>(</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a>   <span class="st">&quot;famid&quot;</span>  , <span class="st">&quot;named&quot;</span>, <span class="st">&quot;incd&quot;</span>, <span class="st">&quot;namem&quot;</span>, <span class="st">&quot;incm&quot;</span> <span class="sc">|</span></span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a>     <span class="dv">1</span>      , <span class="st">&quot;Bill&quot;</span> , <span class="dv">30000</span> , <span class="st">&quot;Bess&quot;</span> , <span class="dv">15000</span>  <span class="sc">|</span></span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a>     <span class="dv">2</span>      , <span class="st">&quot;Art&quot;</span>  , <span class="dv">22000</span> , <span class="st">&quot;Amy&quot;</span>  , <span class="dv">18000</span>  <span class="sc">|</span></span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a>     <span class="dv">3</span>      , <span class="st">&quot;Paul&quot;</span> , <span class="dv">25000</span> , <span class="st">&quot;Pat&quot;</span>  , <span class="dv">50000</span>  )</span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a><span class="co"># to this format</span></span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a>dadmomt <span class="ot">&lt;-</span> wrapr<span class="sc">::</span><span class="fu">build_frame</span>(</span>
<span id="cb1-10"><a href="#cb1-10" tabindex="-1"></a>   <span class="st">&quot;famid&quot;</span>  , <span class="st">&quot;dadmom&quot;</span>, <span class="st">&quot;name&quot;</span>, <span class="st">&quot;inc&quot;</span> <span class="sc">|</span></span>
<span id="cb1-11"><a href="#cb1-11" tabindex="-1"></a>     <span class="dv">1</span>      , <span class="st">&quot;d&quot;</span>     , <span class="st">&quot;Bill&quot;</span>, <span class="dv">30000</span> <span class="sc">|</span></span>
<span id="cb1-12"><a href="#cb1-12" tabindex="-1"></a>     <span class="dv">1</span>      , <span class="st">&quot;m&quot;</span>     , <span class="st">&quot;Bess&quot;</span>, <span class="dv">15000</span> <span class="sc">|</span></span>
<span id="cb1-13"><a href="#cb1-13" tabindex="-1"></a>     <span class="dv">2</span>      , <span class="st">&quot;d&quot;</span>     , <span class="st">&quot;Art&quot;</span> , <span class="dv">22000</span> <span class="sc">|</span></span>
<span id="cb1-14"><a href="#cb1-14" tabindex="-1"></a>     <span class="dv">2</span>      , <span class="st">&quot;m&quot;</span>     , <span class="st">&quot;Amy&quot;</span> , <span class="dv">18000</span> <span class="sc">|</span></span>
<span id="cb1-15"><a href="#cb1-15" tabindex="-1"></a>     <span class="dv">3</span>      , <span class="st">&quot;d&quot;</span>     , <span class="st">&quot;Paul&quot;</span>, <span class="dv">25000</span> <span class="sc">|</span></span>
<span id="cb1-16"><a href="#cb1-16" tabindex="-1"></a>     <span class="dv">3</span>      , <span class="st">&quot;m&quot;</span>     , <span class="st">&quot;Pat&quot;</span> , <span class="dv">50000</span> )</span></code></pre></div>
<p>Each incoming record represents a family, and is designated by the
record key <code>famid</code>. The data starts with each record in a
single row (a row record):</p>
<table>
<thead>
<tr class="header">
<th align="right">famid</th>
<th align="left">named</th>
<th align="right">incd</th>
<th align="left">namem</th>
<th align="right">incm</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="left">Bill</td>
<td align="right">30000</td>
<td align="left">Bess</td>
<td align="right">15000</td>
</tr>
</tbody>
</table>
<p>So we are going from a row record to a general block record: this
means we want to use <code>rowrecs_to_blocks_spec()</code>, and we only
have to describe the outgoing record shape.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;cdata&quot;</span>)</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a><span class="co"># identify the record key</span></span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a>recordKeys <span class="ot">&lt;-</span> <span class="st">&quot;famid&quot;</span></span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a><span class="co"># specify the outgoing record shape</span></span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a>outgoing_record <span class="ot">&lt;-</span> wrapr<span class="sc">::</span><span class="fu">qchar_frame</span>(</span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a>   <span class="st">&quot;dadmom&quot;</span>  , <span class="st">&quot;name&quot;</span>, <span class="st">&quot;inc&quot;</span> <span class="sc">|</span></span>
<span id="cb2-9"><a href="#cb2-9" tabindex="-1"></a>     <span class="st">&quot;d&quot;</span>     , named , incd <span class="sc">|</span></span>
<span id="cb2-10"><a href="#cb2-10" tabindex="-1"></a>     <span class="st">&quot;m&quot;</span>     , namem , incm )</span></code></pre></div>
<p>Notice we take the column names from the incoming row-record and use
them as cell-names in the outgoing record; this is how we show where the
data goes. In specifying the record with
<code>wrapr::qchar_frame()</code>, we use the convention that quoted
entities are values we know (values that specify column names, or keys
that describe the interior of the block record structure), and un-quoted
entities are values we expect to be in the record.</p>
<p><code>outgoing_record</code> is just a <code>data.frame</code>, you
can create it however you like – you don’t need to use
<code>qchar_frame()</code>.</p>
<p>Now create the layout specification, and print it.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="co"># put it all together into a layout</span></span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>layout <span class="ot">&lt;-</span> <span class="fu">rowrecs_to_blocks_spec</span>(</span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a>  outgoing_record,</span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a>  <span class="at">recordKeys =</span> recordKeys)</span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a><span class="co"># confirm we have the right layout</span></span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a><span class="fu">print</span>(layout)</span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a><span class="co">#&gt; {</span></span>
<span id="cb3-9"><a href="#cb3-9" tabindex="-1"></a><span class="co">#&gt;  row_record &lt;- wrapr::qchar_frame(</span></span>
<span id="cb3-10"><a href="#cb3-10" tabindex="-1"></a><span class="co">#&gt;    &quot;famid&quot;  , &quot;named&quot;, &quot;incd&quot;, &quot;namem&quot;, &quot;incm&quot; |</span></span>
<span id="cb3-11"><a href="#cb3-11" tabindex="-1"></a><span class="co">#&gt;      .      , named  , incd  , namem  , incm   )</span></span>
<span id="cb3-12"><a href="#cb3-12" tabindex="-1"></a><span class="co">#&gt;  row_keys &lt;- c(&#39;famid&#39;)</span></span>
<span id="cb3-13"><a href="#cb3-13" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb3-14"><a href="#cb3-14" tabindex="-1"></a><span class="co">#&gt;  # becomes</span></span>
<span id="cb3-15"><a href="#cb3-15" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb3-16"><a href="#cb3-16" tabindex="-1"></a><span class="co">#&gt;  block_record &lt;- wrapr::qchar_frame(</span></span>
<span id="cb3-17"><a href="#cb3-17" tabindex="-1"></a><span class="co">#&gt;    &quot;famid&quot;  , &quot;dadmom&quot;, &quot;name&quot;, &quot;inc&quot; |</span></span>
<span id="cb3-18"><a href="#cb3-18" tabindex="-1"></a><span class="co">#&gt;      .      , &quot;d&quot;     , named , incd  |</span></span>
<span id="cb3-19"><a href="#cb3-19" tabindex="-1"></a><span class="co">#&gt;      .      , &quot;m&quot;     , namem , incm  )</span></span>
<span id="cb3-20"><a href="#cb3-20" tabindex="-1"></a><span class="co">#&gt;  block_keys &lt;- c(&#39;famid&#39;, &#39;dadmom&#39;)</span></span>
<span id="cb3-21"><a href="#cb3-21" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb3-22"><a href="#cb3-22" tabindex="-1"></a><span class="co">#&gt;  # args: c(checkNames = TRUE, checkKeys = FALSE, strict = FALSE, allow_rqdatatable = FALSE)</span></span>
<span id="cb3-23"><a href="#cb3-23" tabindex="-1"></a><span class="co">#&gt; }</span></span></code></pre></div>
<p>The <code>print()</code> method fully documents what columns are
expected and the intent of the data layout transform. It uses the same
quoted/unquoted convention that we used in specifying
<code>outgoing_record</code> above.</p>
<p>The <em>block_keys</em> of the outgoing record shape specify the
unique identifier of each row of the transformed data: that is, each row
of <code>dadmomt</code> will be uniquely identified by the values of the
columns <code>famid</code> and <code>dadmom</code> (which family, which
parent). One of the block keys is always the record key; by default,
<code>rowrecs_to_blocks_spec()</code> takes the other one from the first
column of the <code>outgoing_record</code> shape. You can specify the
block key (or keys) explicitly with the <code>controlTableKeys</code>
argument:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="co"># this is equivalent to the above call</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a><span class="fu">rowrecs_to_blocks_spec</span>(</span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>  outgoing_record,</span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a>  <span class="at">recordKeys =</span> recordKeys,</span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a>  <span class="at">controlTableKeys =</span> <span class="st">&#39;dadmom&#39;</span>)</span></code></pre></div>
<p>Now apply the layout to get the new data shape:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="co"># apply the layout</span></span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>dadmomw <span class="sc">%.&gt;%</span> </span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>  layout <span class="sc">%.&gt;%</span></span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a>  knitr<span class="sc">::</span><span class="fu">kable</span>(.)</span></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="right">famid</th>
<th align="left">dadmom</th>
<th align="left">name</th>
<th align="right">inc</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="left">d</td>
<td align="left">Bill</td>
<td align="right">30000</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="left">m</td>
<td align="left">Bess</td>
<td align="right">15000</td>
</tr>
<tr class="odd">
<td align="right">2</td>
<td align="left">d</td>
<td align="left">Art</td>
<td align="right">22000</td>
</tr>
<tr class="even">
<td align="right">2</td>
<td align="left">m</td>
<td align="left">Amy</td>
<td align="right">18000</td>
</tr>
<tr class="odd">
<td align="right">3</td>
<td align="left">d</td>
<td align="left">Paul</td>
<td align="right">25000</td>
</tr>
<tr class="even">
<td align="right">3</td>
<td align="left">m</td>
<td align="left">Pat</td>
<td align="right">50000</td>
</tr>
</tbody>
</table>
</div>
<div id="example-2" class="section level2">
<h2>Example 2</h2>
<p>(From: <a href="https://github.com/tidyverse/tidyr/blob/0d633f79e85a87a686b2f43de20e2ae74f5c122c/demo/so-15668870.R">tidyr:demo/so-15668870.R</a>,
<a href="https://stackoverflow.com/questions/15668870/reshape-wide-format-to-multi-column-long-format">https://stackoverflow.com/questions/15668870/reshape-wide-format-to-multi-column-long-format</a>,
.)</p>
<p>The original question was:</p>
<pre><code>I want to reshape a wide format dataset that has multiple tests which are measured at 3 time points:

   ID   Test Year   Fall Spring Winter
    1   1   2008    15      16      19
    1   1   2009    12      13      27
    1   2   2008    22      22      24
    1   2   2009    10      14      20
 ...

into a data set that separates the tests by column but converts the measurement time into long format, for each of the new columns like this:

    ID  Year    Time        Test1 Test2
    1   2008    Fall        15      22
    1   2008    Spring      16      22
    1   2008    Winter      19      24
    1   2009    Fall        12      10
    1   2009    Spring      13      14
    1   2009    Winter      27      20
 ...

I have unsuccessfully tried to use reshape and melt. Existing posts address transforming to single column outcome.</code></pre>
<p>First, notice that neither the incoming nor outgoing forms are
single-row records; a single record corresponds to a single ID and Year,
and has three measurements (Fall, Spring, Winter) of two tests (1 and
2). So an example single row record would look something like:</p>
<pre><code>  ID Year Fall1 Fall2 Spring1 Spring2 Winter1 Winter2
   1 2008    15    22      16      22      19      24
</code></pre>
<p>and the record key is formed from the ID and the Year (sometimes what
the record keys are is not obvious, and is in fact domain
knowledge).</p>
<p>Since neither the incoming nor outgoing shapes are row records, we
use the general <code>layout_specification()</code>.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;cdata&quot;</span>)</span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a><span class="co"># identify the record keys</span></span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a>recordKeys <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;ID&quot;</span>, <span class="st">&quot;Year&quot;</span>)</span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a><span class="co"># specify the incoming record shape</span></span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a>incoming_record <span class="ot">&lt;-</span> wrapr<span class="sc">::</span><span class="fu">qchar_frame</span>(</span>
<span id="cb8-8"><a href="#cb8-8" tabindex="-1"></a>  <span class="st">&quot;Test&quot;</span>  , <span class="st">&quot;Fall&quot;</span>   , <span class="st">&quot;Spring&quot;</span>     , <span class="st">&quot;Winter&quot;</span> <span class="sc">|</span></span>
<span id="cb8-9"><a href="#cb8-9" tabindex="-1"></a>    <span class="st">&quot;1&quot;</span>   , Fall1    , Spring1      , Winter1  <span class="sc">|</span></span>
<span id="cb8-10"><a href="#cb8-10" tabindex="-1"></a>    <span class="st">&quot;2&quot;</span>   , Fall2    , Spring2      , Winter2  )</span>
<span id="cb8-11"><a href="#cb8-11" tabindex="-1"></a></span>
<span id="cb8-12"><a href="#cb8-12" tabindex="-1"></a><span class="co"># specify the outgoing record shape</span></span>
<span id="cb8-13"><a href="#cb8-13" tabindex="-1"></a>outgoing_record <span class="ot">&lt;-</span> wrapr<span class="sc">::</span><span class="fu">qchar_frame</span>(</span>
<span id="cb8-14"><a href="#cb8-14" tabindex="-1"></a>  <span class="st">&quot;Time&quot;</span>     , <span class="st">&quot;Test1&quot;</span> ,  <span class="st">&quot;Test2&quot;</span>   <span class="sc">|</span></span>
<span id="cb8-15"><a href="#cb8-15" tabindex="-1"></a>    <span class="st">&quot;Fall&quot;</span>   , Fall1   ,   Fall2    <span class="sc">|</span></span>
<span id="cb8-16"><a href="#cb8-16" tabindex="-1"></a>    <span class="st">&quot;Spring&quot;</span> , Spring1 ,   Spring2  <span class="sc">|</span></span>
<span id="cb8-17"><a href="#cb8-17" tabindex="-1"></a>    <span class="st">&quot;Winter&quot;</span> , Winter1 ,   Winter2  )</span>
<span id="cb8-18"><a href="#cb8-18" tabindex="-1"></a></span>
<span id="cb8-19"><a href="#cb8-19" tabindex="-1"></a><span class="co"># put it all together into a layout</span></span>
<span id="cb8-20"><a href="#cb8-20" tabindex="-1"></a>layout <span class="ot">&lt;-</span> <span class="fu">layout_specification</span>(</span>
<span id="cb8-21"><a href="#cb8-21" tabindex="-1"></a>  <span class="at">incoming_shape =</span> incoming_record,</span>
<span id="cb8-22"><a href="#cb8-22" tabindex="-1"></a>  <span class="at">outgoing_shape =</span> outgoing_record,</span>
<span id="cb8-23"><a href="#cb8-23" tabindex="-1"></a>  <span class="at">recordKeys =</span> recordKeys)</span>
<span id="cb8-24"><a href="#cb8-24" tabindex="-1"></a></span>
<span id="cb8-25"><a href="#cb8-25" tabindex="-1"></a><span class="co"># confirm we have the right layout</span></span>
<span id="cb8-26"><a href="#cb8-26" tabindex="-1"></a><span class="fu">print</span>(layout)</span>
<span id="cb8-27"><a href="#cb8-27" tabindex="-1"></a><span class="co">#&gt; {</span></span>
<span id="cb8-28"><a href="#cb8-28" tabindex="-1"></a><span class="co">#&gt;  in_record &lt;- wrapr::qchar_frame(</span></span>
<span id="cb8-29"><a href="#cb8-29" tabindex="-1"></a><span class="co">#&gt;    &quot;ID&quot;  , &quot;Year&quot;, &quot;Test&quot;, &quot;Fall&quot;, &quot;Spring&quot;, &quot;Winter&quot; |</span></span>
<span id="cb8-30"><a href="#cb8-30" tabindex="-1"></a><span class="co">#&gt;      .   , .     , &quot;1&quot;   , Fall1 , Spring1 , Winter1  |</span></span>
<span id="cb8-31"><a href="#cb8-31" tabindex="-1"></a><span class="co">#&gt;      .   , .     , &quot;2&quot;   , Fall2 , Spring2 , Winter2  )</span></span>
<span id="cb8-32"><a href="#cb8-32" tabindex="-1"></a><span class="co">#&gt;  in_keys &lt;- c(&#39;ID&#39;, &#39;Year&#39;, &#39;Test&#39;)</span></span>
<span id="cb8-33"><a href="#cb8-33" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb8-34"><a href="#cb8-34" tabindex="-1"></a><span class="co">#&gt;  # becomes</span></span>
<span id="cb8-35"><a href="#cb8-35" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb8-36"><a href="#cb8-36" tabindex="-1"></a><span class="co">#&gt;  out_record &lt;- wrapr::qchar_frame(</span></span>
<span id="cb8-37"><a href="#cb8-37" tabindex="-1"></a><span class="co">#&gt;    &quot;ID&quot;  , &quot;Year&quot;, &quot;Time&quot;  , &quot;Test1&quot;, &quot;Test2&quot; |</span></span>
<span id="cb8-38"><a href="#cb8-38" tabindex="-1"></a><span class="co">#&gt;      .   , .     , &quot;Fall&quot;  , Fall1  , Fall2   |</span></span>
<span id="cb8-39"><a href="#cb8-39" tabindex="-1"></a><span class="co">#&gt;      .   , .     , &quot;Spring&quot;, Spring1, Spring2 |</span></span>
<span id="cb8-40"><a href="#cb8-40" tabindex="-1"></a><span class="co">#&gt;      .   , .     , &quot;Winter&quot;, Winter1, Winter2 )</span></span>
<span id="cb8-41"><a href="#cb8-41" tabindex="-1"></a><span class="co">#&gt;  out_keys &lt;- c(&#39;ID&#39;, &#39;Year&#39;, &#39;Time&#39;)</span></span>
<span id="cb8-42"><a href="#cb8-42" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb8-43"><a href="#cb8-43" tabindex="-1"></a><span class="co">#&gt;  # args: c(checkNames = TRUE, checkKeys = TRUE, strict = FALSE, allow_rqdatatable = FALSE)</span></span>
<span id="cb8-44"><a href="#cb8-44" tabindex="-1"></a><span class="co">#&gt; }</span></span>
<span id="cb8-45"><a href="#cb8-45" tabindex="-1"></a></span>
<span id="cb8-46"><a href="#cb8-46" tabindex="-1"></a><span class="co"># example data</span></span>
<span id="cb8-47"><a href="#cb8-47" tabindex="-1"></a>grades <span class="ot">&lt;-</span> wrapr<span class="sc">::</span><span class="fu">build_frame</span>(</span>
<span id="cb8-48"><a href="#cb8-48" tabindex="-1"></a>   <span class="st">&quot;ID&quot;</span>  , <span class="st">&quot;Test&quot;</span>, <span class="st">&quot;Year&quot;</span>, <span class="st">&quot;Fall&quot;</span>, <span class="st">&quot;Spring&quot;</span>, <span class="st">&quot;Winter&quot;</span> <span class="sc">|</span></span>
<span id="cb8-49"><a href="#cb8-49" tabindex="-1"></a>     <span class="dv">1</span>   , <span class="dv">1</span>     , <span class="dv">2008</span>  , <span class="dv">15</span>    , <span class="dv">16</span>      , <span class="dv">19</span>       <span class="sc">|</span></span>
<span id="cb8-50"><a href="#cb8-50" tabindex="-1"></a>     <span class="dv">1</span>   , <span class="dv">1</span>     , <span class="dv">2009</span>  , <span class="dv">12</span>    , <span class="dv">13</span>      , <span class="dv">27</span>       <span class="sc">|</span></span>
<span id="cb8-51"><a href="#cb8-51" tabindex="-1"></a>     <span class="dv">1</span>   , <span class="dv">2</span>     , <span class="dv">2008</span>  , <span class="dv">22</span>    , <span class="dv">22</span>      , <span class="dv">24</span>       <span class="sc">|</span></span>
<span id="cb8-52"><a href="#cb8-52" tabindex="-1"></a>     <span class="dv">1</span>   , <span class="dv">2</span>     , <span class="dv">2009</span>  , <span class="dv">10</span>    , <span class="dv">14</span>      , <span class="dv">20</span>       <span class="sc">|</span></span>
<span id="cb8-53"><a href="#cb8-53" tabindex="-1"></a>     <span class="dv">2</span>   , <span class="dv">1</span>     , <span class="dv">2008</span>  , <span class="dv">12</span>    , <span class="dv">13</span>      , <span class="dv">25</span>       <span class="sc">|</span></span>
<span id="cb8-54"><a href="#cb8-54" tabindex="-1"></a>     <span class="dv">2</span>   , <span class="dv">1</span>     , <span class="dv">2009</span>  , <span class="dv">16</span>    , <span class="dv">14</span>      , <span class="dv">21</span>       <span class="sc">|</span></span>
<span id="cb8-55"><a href="#cb8-55" tabindex="-1"></a>     <span class="dv">2</span>   , <span class="dv">2</span>     , <span class="dv">2008</span>  , <span class="dv">13</span>    , <span class="dv">11</span>      , <span class="dv">29</span>       <span class="sc">|</span></span>
<span id="cb8-56"><a href="#cb8-56" tabindex="-1"></a>     <span class="dv">2</span>   , <span class="dv">2</span>     , <span class="dv">2009</span>  , <span class="dv">23</span>    , <span class="dv">20</span>      , <span class="dv">26</span>       <span class="sc">|</span></span>
<span id="cb8-57"><a href="#cb8-57" tabindex="-1"></a>     <span class="dv">3</span>   , <span class="dv">1</span>     , <span class="dv">2008</span>  , <span class="dv">11</span>    , <span class="dv">12</span>      , <span class="dv">22</span>       <span class="sc">|</span></span>
<span id="cb8-58"><a href="#cb8-58" tabindex="-1"></a>     <span class="dv">3</span>   , <span class="dv">1</span>     , <span class="dv">2009</span>  , <span class="dv">13</span>    , <span class="dv">11</span>      , <span class="dv">27</span>       <span class="sc">|</span></span>
<span id="cb8-59"><a href="#cb8-59" tabindex="-1"></a>     <span class="dv">3</span>   , <span class="dv">2</span>     , <span class="dv">2008</span>  , <span class="dv">17</span>    , <span class="dv">12</span>      , <span class="dv">23</span>       <span class="sc">|</span></span>
<span id="cb8-60"><a href="#cb8-60" tabindex="-1"></a>     <span class="dv">3</span>   , <span class="dv">2</span>     , <span class="dv">2009</span>  , <span class="dv">14</span>    ,  <span class="dv">9</span>      , <span class="dv">31</span>       )</span>
<span id="cb8-61"><a href="#cb8-61" tabindex="-1"></a></span>
<span id="cb8-62"><a href="#cb8-62" tabindex="-1"></a><span class="co"># apply the layout</span></span>
<span id="cb8-63"><a href="#cb8-63" tabindex="-1"></a>grades <span class="sc">%.&gt;%</span> </span>
<span id="cb8-64"><a href="#cb8-64" tabindex="-1"></a>  layout <span class="sc">%.&gt;%</span></span>
<span id="cb8-65"><a href="#cb8-65" tabindex="-1"></a>  knitr<span class="sc">::</span><span class="fu">kable</span>(.)</span></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="right">ID</th>
<th align="right">Year</th>
<th align="left">Time</th>
<th align="right">Test1</th>
<th align="right">Test2</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="right">2008</td>
<td align="left">Fall</td>
<td align="right">15</td>
<td align="right">22</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">2008</td>
<td align="left">Spring</td>
<td align="right">16</td>
<td align="right">22</td>
</tr>
<tr class="odd">
<td align="right">1</td>
<td align="right">2008</td>
<td align="left">Winter</td>
<td align="right">19</td>
<td align="right">24</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">2009</td>
<td align="left">Fall</td>
<td align="right">12</td>
<td align="right">10</td>
</tr>
<tr class="odd">
<td align="right">1</td>
<td align="right">2009</td>
<td align="left">Spring</td>
<td align="right">13</td>
<td align="right">14</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">2009</td>
<td align="left">Winter</td>
<td align="right">27</td>
<td align="right">20</td>
</tr>
<tr class="odd">
<td align="right">2</td>
<td align="right">2008</td>
<td align="left">Fall</td>
<td align="right">12</td>
<td align="right">13</td>
</tr>
<tr class="even">
<td align="right">2</td>
<td align="right">2008</td>
<td align="left">Spring</td>
<td align="right">13</td>
<td align="right">11</td>
</tr>
<tr class="odd">
<td align="right">2</td>
<td align="right">2008</td>
<td align="left">Winter</td>
<td align="right">25</td>
<td align="right">29</td>
</tr>
<tr class="even">
<td align="right">2</td>
<td align="right">2009</td>
<td align="left">Fall</td>
<td align="right">16</td>
<td align="right">23</td>
</tr>
<tr class="odd">
<td align="right">2</td>
<td align="right">2009</td>
<td align="left">Spring</td>
<td align="right">14</td>
<td align="right">20</td>
</tr>
<tr class="even">
<td align="right">2</td>
<td align="right">2009</td>
<td align="left">Winter</td>
<td align="right">21</td>
<td align="right">26</td>
</tr>
<tr class="odd">
<td align="right">3</td>
<td align="right">2008</td>
<td align="left">Fall</td>
<td align="right">11</td>
<td align="right">17</td>
</tr>
<tr class="even">
<td align="right">3</td>
<td align="right">2008</td>
<td align="left">Spring</td>
<td align="right">12</td>
<td align="right">12</td>
</tr>
<tr class="odd">
<td align="right">3</td>
<td align="right">2008</td>
<td align="left">Winter</td>
<td align="right">22</td>
<td align="right">23</td>
</tr>
<tr class="even">
<td align="right">3</td>
<td align="right">2009</td>
<td align="left">Fall</td>
<td align="right">13</td>
<td align="right">14</td>
</tr>
<tr class="odd">
<td align="right">3</td>
<td align="right">2009</td>
<td align="left">Spring</td>
<td align="right">11</td>
<td align="right">9</td>
</tr>
<tr class="even">
<td align="right">3</td>
<td align="right">2009</td>
<td align="left">Winter</td>
<td align="right">27</td>
<td align="right">31</td>
</tr>
</tbody>
</table>
</div>
<div id="example-3" class="section level1">
<h1>Example 3</h1>
<p>(From: <a href="https://github.com/tidyverse/tidyr/blob/0d633f79e85a87a686b2f43de20e2ae74f5c122c/demo/so-16032858.R">tidyr:demo/so-16032858.R</a>
, <a href="https://stackoverflow.com/questions/16032858/reshape-data-from-long-to-a-short-format-by-a-variable-and-rename-columns">https://stackoverflow.com/questions/16032858/reshape-data-from-long-to-a-short-format-by-a-variable-and-rename-columns</a>.)</p>
<p>Question: given data such as below how does one move treatment and
control values for each individual into columns? Or how does one take
<code>a</code> to <code>b</code>?</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a>a <span class="ot">&lt;-</span> wrapr<span class="sc">::</span><span class="fu">build_frame</span>(</span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a>   <span class="st">&quot;Ind&quot;</span>   , <span class="st">&quot;Treatment&quot;</span>, <span class="st">&quot;value&quot;</span> <span class="sc">|</span></span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a>     <span class="st">&quot;Ind1&quot;</span>, <span class="st">&quot;Treat&quot;</span>    , <span class="dv">1</span>       <span class="sc">|</span></span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a>     <span class="st">&quot;Ind2&quot;</span>, <span class="st">&quot;Treat&quot;</span>    , <span class="dv">2</span>       <span class="sc">|</span></span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a>     <span class="st">&quot;Ind1&quot;</span>, <span class="st">&quot;Cont&quot;</span>     , <span class="dv">3</span>       <span class="sc">|</span></span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a>     <span class="st">&quot;Ind2&quot;</span>, <span class="st">&quot;Cont&quot;</span>     , <span class="dv">4</span>       )</span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a></span>
<span id="cb9-8"><a href="#cb9-8" tabindex="-1"></a>b <span class="ot">&lt;-</span> wrapr<span class="sc">::</span><span class="fu">build_frame</span>(</span>
<span id="cb9-9"><a href="#cb9-9" tabindex="-1"></a>   <span class="st">&quot;Ind&quot;</span>   , <span class="st">&quot;Treat&quot;</span> , <span class="st">&quot;Cont&quot;</span><span class="sc">|</span></span>
<span id="cb9-10"><a href="#cb9-10" tabindex="-1"></a>     <span class="st">&quot;Ind1&quot;</span>, <span class="dv">1</span>       , <span class="dv">3</span>     <span class="sc">|</span></span>
<span id="cb9-11"><a href="#cb9-11" tabindex="-1"></a>     <span class="st">&quot;Ind2&quot;</span>, <span class="dv">2</span>       , <span class="dv">4</span>     )</span></code></pre></div>
<p>In this case, a record corresponds to an individual, and the outgoing
data is in row record form:</p>
<table>
<thead>
<tr class="header">
<th align="left">Ind</th>
<th align="right">Treat</th>
<th align="right">Cont</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Ind1</td>
<td align="right">1</td>
<td align="right">3</td>
</tr>
</tbody>
</table>
<p>That means we will use <code>blocks_to_rowrecs_spec()</code>.</p>
<p>The <code>cdata</code> solution is as follows.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;cdata&quot;</span>)</span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a><span class="co"># identify the record key</span></span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a>recordKeys <span class="ot">&lt;-</span> <span class="st">&quot;Ind&quot;</span></span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a><span class="co"># specify the incoming record shape</span></span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a>incoming_record <span class="ot">&lt;-</span> wrapr<span class="sc">::</span><span class="fu">qchar_frame</span>(</span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a>   <span class="st">&quot;Treatment&quot;</span>  , <span class="st">&quot;value&quot;</span> <span class="sc">|</span></span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a>    <span class="st">&quot;Treat&quot;</span>     , Treat   <span class="sc">|</span></span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a>    <span class="st">&quot;Cont&quot;</span>      , Cont    )</span>
<span id="cb10-11"><a href="#cb10-11" tabindex="-1"></a></span>
<span id="cb10-12"><a href="#cb10-12" tabindex="-1"></a></span>
<span id="cb10-13"><a href="#cb10-13" tabindex="-1"></a><span class="co"># put it all together into a layout</span></span>
<span id="cb10-14"><a href="#cb10-14" tabindex="-1"></a>layout <span class="ot">&lt;-</span> <span class="fu">blocks_to_rowrecs_spec</span>(</span>
<span id="cb10-15"><a href="#cb10-15" tabindex="-1"></a>  incoming_record,</span>
<span id="cb10-16"><a href="#cb10-16" tabindex="-1"></a>  <span class="at">recordKeys =</span> recordKeys)</span>
<span id="cb10-17"><a href="#cb10-17" tabindex="-1"></a></span>
<span id="cb10-18"><a href="#cb10-18" tabindex="-1"></a><span class="co"># confirm we have the right layout</span></span>
<span id="cb10-19"><a href="#cb10-19" tabindex="-1"></a><span class="fu">print</span>(layout)</span>
<span id="cb10-20"><a href="#cb10-20" tabindex="-1"></a><span class="co">#&gt; {</span></span>
<span id="cb10-21"><a href="#cb10-21" tabindex="-1"></a><span class="co">#&gt;  block_record &lt;- wrapr::qchar_frame(</span></span>
<span id="cb10-22"><a href="#cb10-22" tabindex="-1"></a><span class="co">#&gt;    &quot;Ind&quot;  , &quot;Treatment&quot;, &quot;value&quot; |</span></span>
<span id="cb10-23"><a href="#cb10-23" tabindex="-1"></a><span class="co">#&gt;      .    , &quot;Treat&quot;    , Treat   |</span></span>
<span id="cb10-24"><a href="#cb10-24" tabindex="-1"></a><span class="co">#&gt;      .    , &quot;Cont&quot;     , Cont    )</span></span>
<span id="cb10-25"><a href="#cb10-25" tabindex="-1"></a><span class="co">#&gt;  block_keys &lt;- c(&#39;Ind&#39;, &#39;Treatment&#39;)</span></span>
<span id="cb10-26"><a href="#cb10-26" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb10-27"><a href="#cb10-27" tabindex="-1"></a><span class="co">#&gt;  # becomes</span></span>
<span id="cb10-28"><a href="#cb10-28" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb10-29"><a href="#cb10-29" tabindex="-1"></a><span class="co">#&gt;  row_record &lt;- wrapr::qchar_frame(</span></span>
<span id="cb10-30"><a href="#cb10-30" tabindex="-1"></a><span class="co">#&gt;    &quot;Ind&quot;  , &quot;Treat&quot;, &quot;Cont&quot; |</span></span>
<span id="cb10-31"><a href="#cb10-31" tabindex="-1"></a><span class="co">#&gt;      .    , Treat  , Cont   )</span></span>
<span id="cb10-32"><a href="#cb10-32" tabindex="-1"></a><span class="co">#&gt;  row_keys &lt;- c(&#39;Ind&#39;)</span></span>
<span id="cb10-33"><a href="#cb10-33" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb10-34"><a href="#cb10-34" tabindex="-1"></a><span class="co">#&gt;  # args: c(checkNames = TRUE, checkKeys = TRUE, strict = FALSE, allow_rqdatatable = FALSE)</span></span>
<span id="cb10-35"><a href="#cb10-35" tabindex="-1"></a><span class="co">#&gt; }</span></span>
<span id="cb10-36"><a href="#cb10-36" tabindex="-1"></a></span>
<span id="cb10-37"><a href="#cb10-37" tabindex="-1"></a><span class="co"># apply the layout</span></span>
<span id="cb10-38"><a href="#cb10-38" tabindex="-1"></a>a <span class="sc">%.&gt;%</span> </span>
<span id="cb10-39"><a href="#cb10-39" tabindex="-1"></a>  layout <span class="sc">%.&gt;%</span></span>
<span id="cb10-40"><a href="#cb10-40" tabindex="-1"></a>  knitr<span class="sc">::</span><span class="fu">kable</span>(.)</span></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">Ind</th>
<th align="right">Treat</th>
<th align="right">Cont</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Ind1</td>
<td align="right">1</td>
<td align="right">3</td>
</tr>
<tr class="even">
<td align="left">Ind2</td>
<td align="right">2</td>
<td align="right">4</td>
</tr>
</tbody>
</table>
<p>This particular transform, from a block consisting of a single column
of values (and the rest of the columns being keys) to a row record, is
the transform typically referred to as <em>spread</em>, <em>dcast</em>,
or <em>pivot</em>. The <code>tidyr</code> package has a convenient call
for this transform: <code>spread()</code>; <code>cdata</code> also has a
similar convenience call: <code>pivot_to_rowrecs()</code>.</p>
<p>Don’t worry if you didn’t notice that this example is a spread; one
of the values of <code>cdata</code> is that you shouldn’t have to think
about it. Most of the examples we show here are neither a simple
spread/pivot nor a simple gather/unpivot.</p>
<p>By now you should be able to see the <code>cdata</code> solution
always follows a very similar path. We try not to let the nature of the
data layout transform (“easy” versus “hard”) dictate the solution
method. Always slow down and draw out the “before” and “after” shapes
before attempting to solve the problem.</p>
</div>
<div id="example-4" class="section level1">
<h1>Example 4</h1>
<p>(From: <a href="https://github.com/tidyverse/tidyr/blob/0d633f79e85a87a686b2f43de20e2ae74f5c122c/demo/so-17481212.R">tidyr:demo/so-17481212.R</a>
, <a href="https://stackoverflow.com/questions/17481212/rearranging-data-frame-in-r">https://stackoverflow.com/questions/17481212/rearranging-data-frame-in-r</a>.)</p>
<p>Convert data that has one different observation for each column to a
data that has all observations in rows. That is take <code>a</code> to
<code>b</code> in the following.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a>a <span class="ot">&lt;-</span> wrapr<span class="sc">::</span><span class="fu">build_frame</span>(</span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a>   <span class="st">&quot;Name&quot;</span>   , <span class="st">&quot;50&quot;</span>, <span class="st">&quot;100&quot;</span>, <span class="st">&quot;150&quot;</span>, <span class="st">&quot;200&quot;</span>, <span class="st">&quot;250&quot;</span>, <span class="st">&quot;300&quot;</span>, <span class="st">&quot;350&quot;</span> <span class="sc">|</span></span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a>     <span class="st">&quot;Carla&quot;</span>, <span class="fl">1.2</span> , <span class="fl">1.8</span>  , <span class="fl">2.2</span>  , <span class="fl">2.3</span>  , <span class="dv">3</span>    , <span class="fl">2.5</span>  , <span class="fl">1.8</span>   <span class="sc">|</span></span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a>     <span class="st">&quot;Mace&quot;</span> , <span class="fl">1.5</span> , <span class="fl">1.1</span>  , <span class="fl">1.9</span>  , <span class="dv">2</span>    , <span class="fl">3.6</span>  , <span class="dv">3</span>    , <span class="fl">2.5</span>   )</span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a>b <span class="ot">&lt;-</span> wrapr<span class="sc">::</span><span class="fu">build_frame</span>(</span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a>   <span class="st">&quot;Name&quot;</span>   , <span class="st">&quot;Time&quot;</span>, <span class="st">&quot;Score&quot;</span> <span class="sc">|</span></span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a>     <span class="st">&quot;Carla&quot;</span>, <span class="dv">50</span>    , <span class="fl">1.2</span>     <span class="sc">|</span></span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a>     <span class="st">&quot;Carla&quot;</span>, <span class="dv">100</span>   , <span class="fl">1.8</span>     <span class="sc">|</span></span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a>     <span class="st">&quot;Carla&quot;</span>, <span class="dv">150</span>   , <span class="fl">2.2</span>     <span class="sc">|</span></span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a>     <span class="st">&quot;Carla&quot;</span>, <span class="dv">200</span>   , <span class="fl">2.3</span>     <span class="sc">|</span></span>
<span id="cb11-12"><a href="#cb11-12" tabindex="-1"></a>     <span class="st">&quot;Carla&quot;</span>, <span class="dv">250</span>   , <span class="dv">3</span>       <span class="sc">|</span></span>
<span id="cb11-13"><a href="#cb11-13" tabindex="-1"></a>     <span class="st">&quot;Carla&quot;</span>, <span class="dv">300</span>   , <span class="fl">2.5</span>     <span class="sc">|</span></span>
<span id="cb11-14"><a href="#cb11-14" tabindex="-1"></a>     <span class="st">&quot;Carla&quot;</span>, <span class="dv">350</span>   , <span class="fl">1.8</span>     <span class="sc">|</span></span>
<span id="cb11-15"><a href="#cb11-15" tabindex="-1"></a>     <span class="st">&quot;Mace&quot;</span> , <span class="dv">50</span>    , <span class="fl">1.5</span>     <span class="sc">|</span></span>
<span id="cb11-16"><a href="#cb11-16" tabindex="-1"></a>     <span class="st">&quot;Mace&quot;</span> , <span class="dv">100</span>   , <span class="fl">1.1</span>     <span class="sc">|</span></span>
<span id="cb11-17"><a href="#cb11-17" tabindex="-1"></a>     <span class="st">&quot;Mace&quot;</span> , <span class="dv">150</span>   , <span class="fl">1.9</span>     <span class="sc">|</span></span>
<span id="cb11-18"><a href="#cb11-18" tabindex="-1"></a>     <span class="st">&quot;Mace&quot;</span> , <span class="dv">200</span>   , <span class="dv">2</span>       <span class="sc">|</span></span>
<span id="cb11-19"><a href="#cb11-19" tabindex="-1"></a>     <span class="st">&quot;Mace&quot;</span> , <span class="dv">250</span>   , <span class="fl">3.6</span>     <span class="sc">|</span></span>
<span id="cb11-20"><a href="#cb11-20" tabindex="-1"></a>     <span class="st">&quot;Mace&quot;</span> , <span class="dv">300</span>   , <span class="dv">3</span>       <span class="sc">|</span></span>
<span id="cb11-21"><a href="#cb11-21" tabindex="-1"></a>     <span class="st">&quot;Mace&quot;</span> , <span class="dv">350</span>   , <span class="fl">2.5</span>     )</span></code></pre></div>
<p>Here a record corresponds to a single observation (keyed by
<code>Name</code>), and the incoming data is arranged in row
records:</p>
<table>
<thead>
<tr class="header">
<th align="left">Name</th>
<th align="right">50</th>
<th align="right">100</th>
<th align="right">150</th>
<th align="right">200</th>
<th align="right">250</th>
<th align="right">300</th>
<th align="right">350</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Carla</td>
<td align="right">1.2</td>
<td align="right">1.8</td>
<td align="right">2.2</td>
<td align="right">2.3</td>
<td align="right">3</td>
<td align="right">2.5</td>
<td align="right">1.8</td>
</tr>
</tbody>
</table>
<p>This particular transformation, from a single row of values to a
single column of values (with multiple key columns), is the transform
commonly called <em>gather</em>, <em>melt</em>, or <em>unpivot</em>.
This is a very common transformation—probably the most common one, by
far. Again, <code>cdata</code> has a convenience function,
<code>pivot_to_blocks()</code> (or its alias
<code>unpivot_to_blocks()</code>).</p>
<p>Here, we will do the transform “the long way” with
<code>rowrecs_to_blocks_spec()</code>. As we have a large number of
columns we will use a helper function to specify the data layout
transform.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;cdata&quot;</span>)</span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a><span class="co"># how to find records</span></span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a>recordKeys <span class="ot">&lt;-</span> <span class="st">&quot;Name&quot;</span></span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a><span class="co"># specify the outgoing record shape, using a helper function</span></span>
<span id="cb12-7"><a href="#cb12-7" tabindex="-1"></a><span class="co"># (and print it --  notice that it&#39;s a data frame)</span></span>
<span id="cb12-8"><a href="#cb12-8" tabindex="-1"></a>( outgoing_record <span class="ot">&lt;-</span> <span class="fu">build_unpivot_control</span>(</span>
<span id="cb12-9"><a href="#cb12-9" tabindex="-1"></a>  <span class="at">nameForNewKeyColumn =</span> <span class="st">&quot;Time&quot;</span>,</span>
<span id="cb12-10"><a href="#cb12-10" tabindex="-1"></a>  <span class="at">nameForNewValueColumn =</span> <span class="st">&quot;Score&quot;</span>,</span>
<span id="cb12-11"><a href="#cb12-11" tabindex="-1"></a>  <span class="at">columnsToTakeFrom =</span> <span class="fu">setdiff</span>(<span class="fu">colnames</span>(a), recordKeys)) )</span>
<span id="cb12-12"><a href="#cb12-12" tabindex="-1"></a><span class="co">#&gt;   Time Score</span></span>
<span id="cb12-13"><a href="#cb12-13" tabindex="-1"></a><span class="co">#&gt; 1   50    50</span></span>
<span id="cb12-14"><a href="#cb12-14" tabindex="-1"></a><span class="co">#&gt; 2  100   100</span></span>
<span id="cb12-15"><a href="#cb12-15" tabindex="-1"></a><span class="co">#&gt; 3  150   150</span></span>
<span id="cb12-16"><a href="#cb12-16" tabindex="-1"></a><span class="co">#&gt; 4  200   200</span></span>
<span id="cb12-17"><a href="#cb12-17" tabindex="-1"></a><span class="co">#&gt; 5  250   250</span></span>
<span id="cb12-18"><a href="#cb12-18" tabindex="-1"></a><span class="co">#&gt; 6  300   300</span></span>
<span id="cb12-19"><a href="#cb12-19" tabindex="-1"></a><span class="co">#&gt; 7  350   350</span></span>
<span id="cb12-20"><a href="#cb12-20" tabindex="-1"></a></span>
<span id="cb12-21"><a href="#cb12-21" tabindex="-1"></a><span class="co"># put it all together into a layout</span></span>
<span id="cb12-22"><a href="#cb12-22" tabindex="-1"></a>layout <span class="ot">&lt;-</span> <span class="fu">rowrecs_to_blocks_spec</span>(</span>
<span id="cb12-23"><a href="#cb12-23" tabindex="-1"></a>  outgoing_record,</span>
<span id="cb12-24"><a href="#cb12-24" tabindex="-1"></a>  <span class="at">recordKeys =</span> recordKeys)</span>
<span id="cb12-25"><a href="#cb12-25" tabindex="-1"></a></span>
<span id="cb12-26"><a href="#cb12-26" tabindex="-1"></a><span class="co"># confirm we have the right layout</span></span>
<span id="cb12-27"><a href="#cb12-27" tabindex="-1"></a><span class="fu">print</span>(layout)</span>
<span id="cb12-28"><a href="#cb12-28" tabindex="-1"></a><span class="co">#&gt; {</span></span>
<span id="cb12-29"><a href="#cb12-29" tabindex="-1"></a><span class="co">#&gt;  row_record &lt;- wrapr::qchar_frame(</span></span>
<span id="cb12-30"><a href="#cb12-30" tabindex="-1"></a><span class="co">#&gt;    &quot;Name&quot;  , &quot;50&quot;, &quot;100&quot;, &quot;150&quot;, &quot;200&quot;, &quot;250&quot;, &quot;300&quot;, &quot;350&quot; |</span></span>
<span id="cb12-31"><a href="#cb12-31" tabindex="-1"></a><span class="co">#&gt;      .     , 50  , 100  , 150  , 200  , 250  , 300  , 350   )</span></span>
<span id="cb12-32"><a href="#cb12-32" tabindex="-1"></a><span class="co">#&gt;  row_keys &lt;- c(&#39;Name&#39;)</span></span>
<span id="cb12-33"><a href="#cb12-33" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb12-34"><a href="#cb12-34" tabindex="-1"></a><span class="co">#&gt;  # becomes</span></span>
<span id="cb12-35"><a href="#cb12-35" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb12-36"><a href="#cb12-36" tabindex="-1"></a><span class="co">#&gt;  block_record &lt;- wrapr::qchar_frame(</span></span>
<span id="cb12-37"><a href="#cb12-37" tabindex="-1"></a><span class="co">#&gt;    &quot;Name&quot;  , &quot;Time&quot;, &quot;Score&quot; |</span></span>
<span id="cb12-38"><a href="#cb12-38" tabindex="-1"></a><span class="co">#&gt;      .     , &quot;50&quot;  , 50      |</span></span>
<span id="cb12-39"><a href="#cb12-39" tabindex="-1"></a><span class="co">#&gt;      .     , &quot;100&quot; , 100     |</span></span>
<span id="cb12-40"><a href="#cb12-40" tabindex="-1"></a><span class="co">#&gt;      .     , &quot;150&quot; , 150     |</span></span>
<span id="cb12-41"><a href="#cb12-41" tabindex="-1"></a><span class="co">#&gt;      .     , &quot;200&quot; , 200     |</span></span>
<span id="cb12-42"><a href="#cb12-42" tabindex="-1"></a><span class="co">#&gt;      .     , &quot;250&quot; , 250     |</span></span>
<span id="cb12-43"><a href="#cb12-43" tabindex="-1"></a><span class="co">#&gt;      .     , &quot;300&quot; , 300     |</span></span>
<span id="cb12-44"><a href="#cb12-44" tabindex="-1"></a><span class="co">#&gt;      .     , &quot;350&quot; , 350     )</span></span>
<span id="cb12-45"><a href="#cb12-45" tabindex="-1"></a><span class="co">#&gt;  block_keys &lt;- c(&#39;Name&#39;, &#39;Time&#39;)</span></span>
<span id="cb12-46"><a href="#cb12-46" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb12-47"><a href="#cb12-47" tabindex="-1"></a><span class="co">#&gt;  # args: c(checkNames = TRUE, checkKeys = FALSE, strict = FALSE, allow_rqdatatable = FALSE)</span></span>
<span id="cb12-48"><a href="#cb12-48" tabindex="-1"></a><span class="co">#&gt; }</span></span>
<span id="cb12-49"><a href="#cb12-49" tabindex="-1"></a></span>
<span id="cb12-50"><a href="#cb12-50" tabindex="-1"></a><span class="co"># apply the layout</span></span>
<span id="cb12-51"><a href="#cb12-51" tabindex="-1"></a>a <span class="sc">%.&gt;%</span> </span>
<span id="cb12-52"><a href="#cb12-52" tabindex="-1"></a>  layout <span class="sc">%.&gt;%</span></span>
<span id="cb12-53"><a href="#cb12-53" tabindex="-1"></a>  <span class="fu">transform</span>(., <span class="at">Time =</span> <span class="fu">as.numeric</span>(Time)) <span class="sc">%.&gt;%</span></span>
<span id="cb12-54"><a href="#cb12-54" tabindex="-1"></a>  <span class="co"># sort the data frame by Name and then Time</span></span>
<span id="cb12-55"><a href="#cb12-55" tabindex="-1"></a>  .[<span class="fu">order</span>(.<span class="sc">$</span>Name, .<span class="sc">$</span>Time), , drop <span class="ot">=</span> <span class="cn">FALSE</span>] <span class="sc">%.&gt;%</span></span>
<span id="cb12-56"><a href="#cb12-56" tabindex="-1"></a>  knitr<span class="sc">::</span><span class="fu">kable</span>(., <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">Name</th>
<th align="right">Time</th>
<th align="right">Score</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Carla</td>
<td align="right">50</td>
<td align="right">1.2</td>
</tr>
<tr class="even">
<td align="left">Carla</td>
<td align="right">100</td>
<td align="right">1.8</td>
</tr>
<tr class="odd">
<td align="left">Carla</td>
<td align="right">150</td>
<td align="right">2.2</td>
</tr>
<tr class="even">
<td align="left">Carla</td>
<td align="right">200</td>
<td align="right">2.3</td>
</tr>
<tr class="odd">
<td align="left">Carla</td>
<td align="right">250</td>
<td align="right">3.0</td>
</tr>
<tr class="even">
<td align="left">Carla</td>
<td align="right">300</td>
<td align="right">2.5</td>
</tr>
<tr class="odd">
<td align="left">Carla</td>
<td align="right">350</td>
<td align="right">1.8</td>
</tr>
<tr class="even">
<td align="left">Mace</td>
<td align="right">50</td>
<td align="right">1.5</td>
</tr>
<tr class="odd">
<td align="left">Mace</td>
<td align="right">100</td>
<td align="right">1.1</td>
</tr>
<tr class="even">
<td align="left">Mace</td>
<td align="right">150</td>
<td align="right">1.9</td>
</tr>
<tr class="odd">
<td align="left">Mace</td>
<td align="right">200</td>
<td align="right">2.0</td>
</tr>
<tr class="even">
<td align="left">Mace</td>
<td align="right">250</td>
<td align="right">3.6</td>
</tr>
<tr class="odd">
<td align="left">Mace</td>
<td align="right">300</td>
<td align="right">3.0</td>
</tr>
<tr class="even">
<td align="left">Mace</td>
<td align="right">350</td>
<td align="right">2.5</td>
</tr>
</tbody>
</table>
</div>
<div id="example-5" class="section level1">
<h1>Example 5</h1>
<p>(From: <a href="https://github.com/tidyverse/tidyr/blob/0d633f79e85a87a686b2f43de20e2ae74f5c122c/demo/so-9684671.R">tidyr:demo/so-9684671.R</a>
, <a href="https://stackoverflow.com/questions/9684671/wide-to-long-multiple-measures-each-time">https://stackoverflow.com/questions/9684671/wide-to-long-multiple-measures-each-time</a>.)</p>
<p>Convert from <code>a</code> to <code>b</code>.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a>a <span class="ot">&lt;-</span> wrapr<span class="sc">::</span><span class="fu">build_frame</span>(</span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a>   <span class="st">&quot;id&quot;</span>    , <span class="st">&quot;trt&quot;</span>, <span class="st">&quot;work.T1&quot;</span>, <span class="st">&quot;play.T1&quot;</span>, <span class="st">&quot;talk.T1&quot;</span>, <span class="st">&quot;total.T1&quot;</span>, <span class="st">&quot;work.T2&quot;</span>, <span class="st">&quot;play.T2&quot;</span>, <span class="st">&quot;talk.T2&quot;</span>, <span class="st">&quot;total.T2&quot;</span> <span class="sc">|</span></span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a>     <span class="st">&quot;x1.1&quot;</span>, <span class="st">&quot;cnt&quot;</span>, <span class="fl">0.3443</span>   , <span class="fl">0.7842</span>   , <span class="fl">0.1079</span>   , <span class="fl">0.888</span>     , <span class="fl">0.6484</span>   , <span class="fl">0.8795</span>   , <span class="fl">0.7234</span>   , <span class="fl">0.5631</span>     <span class="sc">|</span></span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a>     <span class="st">&quot;x1.2&quot;</span>, <span class="st">&quot;tr&quot;</span> , <span class="fl">0.06132</span>  , <span class="fl">0.8427</span>   , <span class="fl">0.3339</span>   , <span class="fl">0.04686</span>   , <span class="fl">0.2348</span>   , <span class="fl">0.1971</span>   , <span class="fl">0.5164</span>   , <span class="fl">0.7618</span>     )</span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a></span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a>b <span class="ot">&lt;-</span> wrapr<span class="sc">::</span><span class="fu">build_frame</span>(</span>
<span id="cb13-7"><a href="#cb13-7" tabindex="-1"></a>   <span class="st">&quot;id&quot;</span>    , <span class="st">&quot;trt&quot;</span>, <span class="st">&quot;time&quot;</span>, <span class="st">&quot;work&quot;</span> , <span class="st">&quot;play&quot;</span>, <span class="st">&quot;talk&quot;</span>, <span class="st">&quot;total&quot;</span> <span class="sc">|</span></span>
<span id="cb13-8"><a href="#cb13-8" tabindex="-1"></a>     <span class="st">&quot;x1.1&quot;</span>, <span class="st">&quot;cnt&quot;</span>, <span class="st">&quot;T1&quot;</span>  , <span class="fl">0.3443</span> , <span class="fl">0.7842</span>, <span class="fl">0.1079</span>, <span class="fl">0.888</span>   <span class="sc">|</span></span>
<span id="cb13-9"><a href="#cb13-9" tabindex="-1"></a>     <span class="st">&quot;x1.1&quot;</span>, <span class="st">&quot;cnt&quot;</span>, <span class="st">&quot;T2&quot;</span>  , <span class="fl">0.6484</span> , <span class="fl">0.8795</span>, <span class="fl">0.7234</span>, <span class="fl">0.5631</span>  <span class="sc">|</span></span>
<span id="cb13-10"><a href="#cb13-10" tabindex="-1"></a>     <span class="st">&quot;x1.2&quot;</span>, <span class="st">&quot;tr&quot;</span> , <span class="st">&quot;T1&quot;</span>  , <span class="fl">0.06132</span>, <span class="fl">0.8427</span>, <span class="fl">0.3339</span>, <span class="fl">0.04686</span> <span class="sc">|</span></span>
<span id="cb13-11"><a href="#cb13-11" tabindex="-1"></a>     <span class="st">&quot;x1.2&quot;</span>, <span class="st">&quot;tr&quot;</span> , <span class="st">&quot;T2&quot;</span>  , <span class="fl">0.2348</span> , <span class="fl">0.1971</span>, <span class="fl">0.5164</span>, <span class="fl">0.7618</span>  )</span></code></pre></div>
<p>A record is an observation, keyed by <code>id</code> (plus
<code>trt</code>, which is a function of <code>id</code>).</p>
<table>
<colgroup>
<col width="6%" />
<col width="5%" />
<col width="10%" />
<col width="10%" />
<col width="10%" />
<col width="12%" />
<col width="10%" />
<col width="10%" />
<col width="10%" />
<col width="12%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">id</th>
<th align="left">trt</th>
<th align="right">work.T1</th>
<th align="right">play.T1</th>
<th align="right">talk.T1</th>
<th align="right">total.T1</th>
<th align="right">work.T2</th>
<th align="right">play.T2</th>
<th align="right">talk.T2</th>
<th align="right">total.T2</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">x1.1</td>
<td align="left">cnt</td>
<td align="right">0.3443</td>
<td align="right">0.7842</td>
<td align="right">0.1079</td>
<td align="right">0.888</td>
<td align="right">0.6484</td>
<td align="right">0.8795</td>
<td align="right">0.7234</td>
<td align="right">0.5631</td>
</tr>
</tbody>
</table>
<p>The incoming data is in row record format, so we can use
<code>rowrecs_to_blocks_spec()</code>.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;cdata&quot;</span>)</span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a><span class="co"># identify the record keys</span></span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a>recordKeys <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;id&quot;</span>, <span class="st">&quot;trt&quot;</span>)</span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a></span>
<span id="cb14-6"><a href="#cb14-6" tabindex="-1"></a><span class="co"># specify the outgoing record shape</span></span>
<span id="cb14-7"><a href="#cb14-7" tabindex="-1"></a>outgoing_record <span class="ot">&lt;-</span> wrapr<span class="sc">::</span><span class="fu">qchar_frame</span>(</span>
<span id="cb14-8"><a href="#cb14-8" tabindex="-1"></a>    <span class="st">&quot;time&quot;</span>  , <span class="st">&quot;work&quot;</span> , <span class="st">&quot;play&quot;</span> , <span class="st">&quot;talk&quot;</span> , <span class="st">&quot;total&quot;</span>  <span class="sc">|</span></span>
<span id="cb14-9"><a href="#cb14-9" tabindex="-1"></a>    <span class="st">&quot;T1&quot;</span>    , work.T1, play.T1, talk.T1, total.T1 <span class="sc">|</span></span>
<span id="cb14-10"><a href="#cb14-10" tabindex="-1"></a>    <span class="st">&quot;T2&quot;</span>    , work.T2, play.T2, talk.T2, total.T2 )</span>
<span id="cb14-11"><a href="#cb14-11" tabindex="-1"></a></span>
<span id="cb14-12"><a href="#cb14-12" tabindex="-1"></a><span class="co"># put it all together into a layout</span></span>
<span id="cb14-13"><a href="#cb14-13" tabindex="-1"></a>layout <span class="ot">&lt;-</span> <span class="fu">rowrecs_to_blocks_spec</span>(</span>
<span id="cb14-14"><a href="#cb14-14" tabindex="-1"></a>  outgoing_record,</span>
<span id="cb14-15"><a href="#cb14-15" tabindex="-1"></a>  <span class="at">recordKeys =</span> recordKeys)</span>
<span id="cb14-16"><a href="#cb14-16" tabindex="-1"></a></span>
<span id="cb14-17"><a href="#cb14-17" tabindex="-1"></a><span class="co"># confirm we have the right layout</span></span>
<span id="cb14-18"><a href="#cb14-18" tabindex="-1"></a><span class="fu">print</span>(layout)</span>
<span id="cb14-19"><a href="#cb14-19" tabindex="-1"></a><span class="co">#&gt; {</span></span>
<span id="cb14-20"><a href="#cb14-20" tabindex="-1"></a><span class="co">#&gt;  row_record &lt;- wrapr::qchar_frame(</span></span>
<span id="cb14-21"><a href="#cb14-21" tabindex="-1"></a><span class="co">#&gt;    &quot;id&quot;  , &quot;trt&quot;, &quot;work.T1&quot;, &quot;play.T1&quot;, &quot;talk.T1&quot;, &quot;total.T1&quot;, &quot;work.T2&quot;, &quot;play.T2&quot;, &quot;talk.T2&quot;, &quot;total.T2&quot; |</span></span>
<span id="cb14-22"><a href="#cb14-22" tabindex="-1"></a><span class="co">#&gt;      .   , .    , work.T1  , play.T1  , talk.T1  , total.T1  , work.T2  , play.T2  , talk.T2  , total.T2   )</span></span>
<span id="cb14-23"><a href="#cb14-23" tabindex="-1"></a><span class="co">#&gt;  row_keys &lt;- c(&#39;id&#39;, &#39;trt&#39;)</span></span>
<span id="cb14-24"><a href="#cb14-24" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb14-25"><a href="#cb14-25" tabindex="-1"></a><span class="co">#&gt;  # becomes</span></span>
<span id="cb14-26"><a href="#cb14-26" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb14-27"><a href="#cb14-27" tabindex="-1"></a><span class="co">#&gt;  block_record &lt;- wrapr::qchar_frame(</span></span>
<span id="cb14-28"><a href="#cb14-28" tabindex="-1"></a><span class="co">#&gt;    &quot;id&quot;  , &quot;trt&quot;, &quot;time&quot;, &quot;work&quot; , &quot;play&quot; , &quot;talk&quot; , &quot;total&quot;  |</span></span>
<span id="cb14-29"><a href="#cb14-29" tabindex="-1"></a><span class="co">#&gt;      .   , .    , &quot;T1&quot;  , work.T1, play.T1, talk.T1, total.T1 |</span></span>
<span id="cb14-30"><a href="#cb14-30" tabindex="-1"></a><span class="co">#&gt;      .   , .    , &quot;T2&quot;  , work.T2, play.T2, talk.T2, total.T2 )</span></span>
<span id="cb14-31"><a href="#cb14-31" tabindex="-1"></a><span class="co">#&gt;  block_keys &lt;- c(&#39;id&#39;, &#39;trt&#39;, &#39;time&#39;)</span></span>
<span id="cb14-32"><a href="#cb14-32" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb14-33"><a href="#cb14-33" tabindex="-1"></a><span class="co">#&gt;  # args: c(checkNames = TRUE, checkKeys = FALSE, strict = FALSE, allow_rqdatatable = FALSE)</span></span>
<span id="cb14-34"><a href="#cb14-34" tabindex="-1"></a><span class="co">#&gt; }</span></span>
<span id="cb14-35"><a href="#cb14-35" tabindex="-1"></a></span>
<span id="cb14-36"><a href="#cb14-36" tabindex="-1"></a><span class="co"># apply the layout</span></span>
<span id="cb14-37"><a href="#cb14-37" tabindex="-1"></a>a <span class="sc">%.&gt;%</span> </span>
<span id="cb14-38"><a href="#cb14-38" tabindex="-1"></a>  layout <span class="sc">%.&gt;%</span></span>
<span id="cb14-39"><a href="#cb14-39" tabindex="-1"></a>  <span class="co"># reorder the frame by the record keys plus time</span></span>
<span id="cb14-40"><a href="#cb14-40" tabindex="-1"></a>  .[wrapr<span class="sc">::</span><span class="fu">orderv</span>(.[ , <span class="fu">c</span>(recordKeys, <span class="st">&quot;time&quot;</span>), <span class="at">drop =</span> <span class="cn">FALSE</span>]), , drop <span class="ot">=</span> <span class="cn">FALSE</span>] <span class="sc">%.&gt;%</span></span>
<span id="cb14-41"><a href="#cb14-41" tabindex="-1"></a>  knitr<span class="sc">::</span><span class="fu">kable</span>(., <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">id</th>
<th align="left">trt</th>
<th align="left">time</th>
<th align="right">work</th>
<th align="right">play</th>
<th align="right">talk</th>
<th align="right">total</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">x1.1</td>
<td align="left">cnt</td>
<td align="left">T1</td>
<td align="right">0.34430</td>
<td align="right">0.7842</td>
<td align="right">0.1079</td>
<td align="right">0.88800</td>
</tr>
<tr class="even">
<td align="left">x1.1</td>
<td align="left">cnt</td>
<td align="left">T2</td>
<td align="right">0.64840</td>
<td align="right">0.8795</td>
<td align="right">0.7234</td>
<td align="right">0.56310</td>
</tr>
<tr class="odd">
<td align="left">x1.2</td>
<td align="left">tr</td>
<td align="left">T1</td>
<td align="right">0.06132</td>
<td align="right">0.8427</td>
<td align="right">0.3339</td>
<td align="right">0.04686</td>
</tr>
<tr class="even">
<td align="left">x1.2</td>
<td align="left">tr</td>
<td align="left">T2</td>
<td align="right">0.23480</td>
<td align="right">0.1971</td>
<td align="right">0.5164</td>
<td align="right">0.76180</td>
</tr>
</tbody>
</table>
<div id="reversing-transforms" class="section level2">
<h2>Reversing Transforms</h2>
<p><code>cdata</code> transform specifications are usually reversible or
invertible (and this can be enforced). So in solving any one of the
above problems the user has complete freedom to try and solve “moving
from a to b” or “moving from b to a” (and can pick whichever they find
easier).</p>
<p>For example continuing with example 5, we can reverse the data layout
transform using the <code>t()</code> function.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a>inv_layout <span class="ot">&lt;-</span> <span class="fu">t</span>(layout)</span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a><span class="fu">print</span>(inv_layout)</span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a><span class="co">#&gt; {</span></span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a><span class="co">#&gt;  block_record &lt;- wrapr::qchar_frame(</span></span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a><span class="co">#&gt;    &quot;id&quot;  , &quot;trt&quot;, &quot;time&quot;, &quot;work&quot; , &quot;play&quot; , &quot;talk&quot; , &quot;total&quot;  |</span></span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a><span class="co">#&gt;      .   , .    , &quot;T1&quot;  , work.T1, play.T1, talk.T1, total.T1 |</span></span>
<span id="cb15-8"><a href="#cb15-8" tabindex="-1"></a><span class="co">#&gt;      .   , .    , &quot;T2&quot;  , work.T2, play.T2, talk.T2, total.T2 )</span></span>
<span id="cb15-9"><a href="#cb15-9" tabindex="-1"></a><span class="co">#&gt;  block_keys &lt;- c(&#39;id&#39;, &#39;trt&#39;, &#39;time&#39;)</span></span>
<span id="cb15-10"><a href="#cb15-10" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb15-11"><a href="#cb15-11" tabindex="-1"></a><span class="co">#&gt;  # becomes</span></span>
<span id="cb15-12"><a href="#cb15-12" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb15-13"><a href="#cb15-13" tabindex="-1"></a><span class="co">#&gt;  row_record &lt;- wrapr::qchar_frame(</span></span>
<span id="cb15-14"><a href="#cb15-14" tabindex="-1"></a><span class="co">#&gt;    &quot;id&quot;  , &quot;trt&quot;, &quot;work.T1&quot;, &quot;play.T1&quot;, &quot;talk.T1&quot;, &quot;total.T1&quot;, &quot;work.T2&quot;, &quot;play.T2&quot;, &quot;talk.T2&quot;, &quot;total.T2&quot; |</span></span>
<span id="cb15-15"><a href="#cb15-15" tabindex="-1"></a><span class="co">#&gt;      .   , .    , work.T1  , play.T1  , talk.T1  , total.T1  , work.T2  , play.T2  , talk.T2  , total.T2   )</span></span>
<span id="cb15-16"><a href="#cb15-16" tabindex="-1"></a><span class="co">#&gt;  row_keys &lt;- c(&#39;id&#39;, &#39;trt&#39;)</span></span>
<span id="cb15-17"><a href="#cb15-17" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb15-18"><a href="#cb15-18" tabindex="-1"></a><span class="co">#&gt;  # args: c(checkNames = TRUE, checkKeys = FALSE, strict = FALSE, allow_rqdatatable = FALSE)</span></span>
<span id="cb15-19"><a href="#cb15-19" tabindex="-1"></a><span class="co">#&gt; }</span></span>
<span id="cb15-20"><a href="#cb15-20" tabindex="-1"></a></span>
<span id="cb15-21"><a href="#cb15-21" tabindex="-1"></a><span class="co"># apply the inverse layout</span></span>
<span id="cb15-22"><a href="#cb15-22" tabindex="-1"></a>b <span class="sc">%.&gt;%</span> </span>
<span id="cb15-23"><a href="#cb15-23" tabindex="-1"></a>  inv_layout <span class="sc">%.&gt;%</span></span>
<span id="cb15-24"><a href="#cb15-24" tabindex="-1"></a>  knitr<span class="sc">::</span><span class="fu">kable</span>(.)</span></code></pre></div>
<table>
<colgroup>
<col width="6%" />
<col width="5%" />
<col width="10%" />
<col width="10%" />
<col width="10%" />
<col width="12%" />
<col width="10%" />
<col width="10%" />
<col width="10%" />
<col width="12%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">id</th>
<th align="left">trt</th>
<th align="right">work.T1</th>
<th align="right">play.T1</th>
<th align="right">talk.T1</th>
<th align="right">total.T1</th>
<th align="right">work.T2</th>
<th align="right">play.T2</th>
<th align="right">talk.T2</th>
<th align="right">total.T2</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">x1.1</td>
<td align="left">cnt</td>
<td align="right">0.34430</td>
<td align="right">0.7842</td>
<td align="right">0.1079</td>
<td align="right">0.88800</td>
<td align="right">0.6484</td>
<td align="right">0.8795</td>
<td align="right">0.7234</td>
<td align="right">0.5631</td>
</tr>
<tr class="even">
<td align="left">x1.2</td>
<td align="left">tr</td>
<td align="right">0.06132</td>
<td align="right">0.8427</td>
<td align="right">0.3339</td>
<td align="right">0.04686</td>
<td align="right">0.2348</td>
<td align="right">0.1971</td>
<td align="right">0.5164</td>
<td align="right">0.7618</td>
</tr>
</tbody>
</table>
<p>In this case, the inverse transform recovered the original row and
column order of <code>a</code>, but this is not guaranteed.</p>
</div>
<div id="package-entry-points" class="section level2">
<h2>Package entry points</h2>
<p>The main <code>cdata</code> interfaces are given by the following set
of methods:</p>
<ul>
<li><a href="https://winvector.github.io/cdata/reference/rowrecs_to_blocks_spec.html"><code>rowrecs_to_blocks_spec()</code></a>,
for specifying how single row records map to general multi-row (or
block) records.</li>
<li><a href="https://winvector.github.io/cdata/reference/blocks_to_rowrecs_spec.html"><code>blocks_to_rowrecs_spec()</code></a>,
for specifying how multi-row block records map to single-row
records.</li>
<li><a href="https://winvector.github.io/cdata/reference/layout_specification.html"><code>layout_specification()</code></a>,
for specifying transforms from multi-row records to other multi-row
records.</li>
<li><a href="https://winvector.github.io/cdata/reference/layout_by.html"><code>layout_by()</code></a>
or the <a href="https://winvector.github.io/wrapr/reference/dot_arrow.html">wrapr
dot arrow pipe</a> for applying a layout to re-arrange data.</li>
<li><code>t()</code> (transpose/adjoint) to invert or reverse layout
specifications.</li>
</ul>
<p>Some convenience functions include:</p>
<ul>
<li><a href="https://winvector.github.io/cdata/reference/pivot_to_rowrecs.html"><code>pivot_to_rowrecs()</code></a>,
for moving data from multi-row block records with one value per row (a
single column of values) to single-row records [<code>spread</code> or
<code>dcast</code>].</li>
<li><a href="https://winvector.github.io/cdata/reference/unpivot_to_blocks.html"><code>pivot_to_blocks()</code>/<code>unpivot_to_blocks()</code></a>,
for moving data from single-row records to possibly multi row block
records with one row per value (a single column of values)
[<code>gather</code> or <code>melt</code>].</li>
<li><a href="https://winvector.github.io/wrapr/reference/qchar_frame.html"><code>wrapr::qchar_frame()</code></a>
a helper function for specifying record control table layout
specifications.</li>
<li><a href="https://winvector.github.io/wrapr/reference/build_frame.html"><code>wrapr::build_frame()</code></a>
a helper function for specifying data frames.</li>
</ul>
<p>The package vignettes can be found in the “Articles” tab of <a href="https://winvector.github.io/cdata/">the <code>cdata</code>
documentation site</a>.</p>
</div>
<div id="conclusion" class="section level2">
<h2>Conclusion</h2>
<p>The key step in using <code>cdata</code> is to understand the record
structure: what constitutes a record, what it would look like in a
single row, and how the records are keyed. <strong>This is not always
easy.</strong> However, understanding your data record layout
<em>is</em> worth the effort. Once you understand the record structure
of your data, the rest is relatively straightforward. Really all one is
doing when using <code>cdata</code> is formalizing the transform “ask”
into a machine readable example.</p>
<p>To make your own solutions, we suggest trying one of the above
example solutions as a template. The idea of having the data layout
transform be simple data (a <code>list</code> of a couple of
<code>data.frame</code>s) means one can use the full power of
<code>R</code> and other <code>R</code> packages to build the data
layout transform specification (one isn’t limited to some interface
grammar specified by the data layout transform package). The idea of
using arbitrary code to build up a data layout transform was used to
good end in the grid scatter-plot example <a href="https://github.com/WinVector/cdata">here</a>.</p>
<p>We also note the value of being able to print and review the bulk of
data layout transform, as it documents expected incoming data columns
and interior block record key values.</p>
</div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
